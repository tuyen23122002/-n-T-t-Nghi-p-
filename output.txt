Project Path: \\?\D:\Project\-n-T-t-Nghi-p-

Source Tree:

```
-n-T-t-Nghi-p-
â”œâ”€â”€ app.py
â”œâ”€â”€ chainlit.md
â”œâ”€â”€ chat_history
â”‚   â””â”€â”€ thread_1762317883.63536.json
â”œâ”€â”€ checkpoints.sqlite
â”œâ”€â”€ endpoints.py
â”œâ”€â”€ img
â”‚   â””â”€â”€ workflow_graph.png
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ flight_booking_agent
â”‚   â”‚   â”œâ”€â”€ agents
â”‚   â”‚   â”‚   â”œâ”€â”€ booking.py
â”‚   â”‚   â”‚   â”œâ”€â”€ cancel_booking.py
â”‚   â”‚   â”‚   â”œâ”€â”€ general.py
â”‚   â”‚   â”‚   â”œâ”€â”€ manager.py
â”‚   â”‚   â”‚   â”œâ”€â”€ router.py
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.py
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ __pycache__
â”‚   â”‚   â”‚       â”œâ”€â”€ booking.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ booking_manager.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ cancel_booking.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ flight_searcher.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ general.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ information_gatherer.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ manager.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ recommendation.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ router.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ utils.cpython-310.pyc
â”‚   â”‚   â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”‚   â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”‚   â”œâ”€â”€ endpoints.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.py
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py
â”‚   â”‚   â”œâ”€â”€ graph
â”‚   â”‚   â”‚   â”œâ”€â”€ state.py
â”‚   â”‚   â”‚   â”œâ”€â”€ workflow.py
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ __pycache__
â”‚   â”‚   â”‚       â”œâ”€â”€ state.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ workflow.cpython-310.pyc
â”‚   â”‚   â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”‚   â”‚   â”œâ”€â”€ output.txt
â”‚   â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”‚   â”œâ”€â”€ amadeus_client.py
â”‚   â”‚   â”‚   â”œâ”€â”€ payment_client.py
â”‚   â”‚   â”‚   â”œâ”€â”€ skyscanner_client.py
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ __pycache__
â”‚   â”‚   â”‚       â”œâ”€â”€ amadeus_client.cpython-310.pyc
â”‚   â”‚   â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”‚   â”‚   â”œâ”€â”€ tools
â”‚   â”‚   â”‚   â”œâ”€â”€ booking_tools.py
â”‚   â”‚   â”‚   â”œâ”€â”€ cancel_tools.py
â”‚   â”‚   â”‚   â”œâ”€â”€ general_tools.py
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ __pycache__
â”‚   â”‚   â”‚       â”œâ”€â”€ booking_tools.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ flight_tools.cpython-310.pyc
â”‚   â”‚   â”‚       â”œâ”€â”€ general_tools.cpython-310.pyc
â”‚   â”‚   â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ __pycache__
â”‚   â”‚       â”œâ”€â”€ config.cpython-310.pyc
â”‚   â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ tests
â”‚   â”œâ”€â”€ test_agents.py
â”‚   â”œâ”€â”€ test_tools.py
â”‚   â”œâ”€â”€ test_workflow.py
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ __pycache__
    â”œâ”€â”€ app.cpython-310.pyc
    â”œâ”€â”€ endpoints.cpython-310.pyc
    â””â”€â”€ endpoints.cpython-313.pyc

```

`\\?\D:\Project\-n-T-t-Nghi-p-\app.py`:

```````py
import chainlit as cl
import httpx
import uuid

# URL cá»§a FastAPI backend
BASE_URL = "http://127.0.0.1:8001"  # Thay Ä‘á»•i náº¿u FastAPI cá»§a báº¡n cháº¡y trÃªn má»™t Ä‘á»‹a chá»‰ khÃ¡c

@cl.on_chat_start
async def on_chat_start():
    """
    HÃ m nÃ y Ä‘Æ°á»£c gá»i khi má»™t cuá»™c trÃ² chuyá»‡n má»›i báº¯t Ä‘áº§u.
    NÃ³ táº¡o ra má»™t thread_id duy nháº¥t cho má»—i cuá»™c trÃ² chuyá»‡n.
    """
    # Táº¡o má»™t thread_id má»›i cho má»—i phiÃªn trÃ² chuyá»‡n
    thread_id = str(uuid.uuid4())
    cl.user_session.set("thread_id", thread_id)

    await cl.Message(
        content=f"Xin chÃ o! ğŸ‘‹ MÃ¬nh lÃ  FlyAgent â€“ trá»£ lÃ½ Ä‘áº·t vÃ© mÃ¡y bay cá»§a báº¡n.",
    ).send()


@cl.on_message
async def on_message(message: cl.Message):
    """
    HÃ m nÃ y Ä‘Æ°á»£c gá»i má»—i khi ngÆ°á»i dÃ¹ng gá»­i má»™t tin nháº¯n.
    NÃ³ gá»­i tin nháº¯n Ä‘áº¿n API FastAPI vÃ  hiá»ƒn thá»‹ pháº£n há»“i.
    """
    thread_id = cl.user_session.get("thread_id")

    if not thread_id:
        # Xá»­ lÃ½ trÆ°á»ng há»£p khÃ´ng tÃ¬m tháº¥y thread_id
        await cl.Message(
            content="ÄÃ£ xáº£y ra lá»—i: khÃ´ng tÃ¬m tháº¥y thread_id. Vui lÃ²ng thá»­ lÃ m má»›i trang."
        ).send()
        return

    # Dá»¯ liá»‡u Ä‘á»ƒ gá»­i Ä‘áº¿n API
    chat_request = {
        "message": message.content,
        "thread_id": thread_id
    }

    async with httpx.AsyncClient() as client:
        try:
            # Gá»­i yÃªu cáº§u POST Ä‘áº¿n endpoint /chat
            response = await client.post(f"{BASE_URL}/chat", json=chat_request, timeout=30.0)
            response.raise_for_status()  # NÃ©m ra má»™t ngoáº¡i lá»‡ náº¿u cÃ³ lá»—i HTTP

            chat_response = response.json()

            # Gá»­i pháº£n há»“i cá»§a bot trá»Ÿ láº¡i giao diá»‡n ngÆ°á»i dÃ¹ng
            await cl.Message(
                content=chat_response.get("response", "KhÃ´ng nháº­n Ä‘Æ°á»£c pháº£n há»“i há»£p lá»‡ tá»« bot."),
            ).send()

        except httpx.HTTPStatusError as e:
            await cl.Message(
                content=f"ÄÃ£ xáº£y ra lá»—i khi giao tiáº¿p vá»›i bot: {e.response.status_code} - {e.response.text}",
            ).send()
        except httpx.RequestError as e:
            await cl.Message(
                content=f"ÄÃ£ xáº£y ra lá»—i máº¡ng: {e}",
            ).send()
        except Exception as e:
            await cl.Message(
                content=f"ÄÃ£ xáº£y ra má»™t lá»—i khÃ´ng mong muá»‘n: {e}",
            ).send()
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\chainlit.md`:

```````md
# Welcome to Chainlit! ğŸš€ğŸ¤–

Hi there, Developer! ğŸ‘‹ We're excited to have you on board. Chainlit is a powerful tool designed to help you prototype, debug and share applications built on top of LLMs.

## Useful Links ğŸ”—

- **Documentation:** Get started with our comprehensive [Chainlit Documentation](https://docs.chainlit.io) ğŸ“š
- **Discord Community:** Join our friendly [Chainlit Discord](https://discord.gg/k73SQ3FyUh) to ask questions, share your projects, and connect with other developers! ğŸ’¬

We can't wait to see what you create with Chainlit! Happy coding! ğŸ’»ğŸ˜Š

## Welcome screen

To modify the welcome screen, edit the `chainlit.md` file at the root of your project. If you do not want a welcome screen, just leave this file empty.

```````

`\\?\D:\Project\-n-T-t-Nghi-p-\chat_history\thread_1762317883.63536.json`:

```````json
{
  "thread_id": "thread_1762317883.63536",
  "title": "helo",
  "created_at": "2025-11-05T11:44:53.146368",
  "updated_at": "2025-11-05T11:44:53.146368",
  "messages": [
    {
      "type": "human",
      "content": "helo"
    }
  ]
}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\endpoints.py`:

```````py
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from langchain_core.messages import HumanMessage
import traceback

from src.flight_booking_agent.graph.workflow import app as graph_app

fastapi_app = FastAPI()

class ChatRequest(BaseModel):
    message: str
    thread_id: str  
    
class ChatResponse(BaseModel):
    response: str
    thread_id: str

@fastapi_app.post("/chat", response_model=ChatResponse)
async def chat_endpoint(request: ChatRequest):
    """
    Endpoint xá»­ lÃ½ chat vá»›i checkpoint.
    Má»—i thread_id Ä‘áº¡i diá»‡n cho 1 cuá»™c há»™i thoáº¡i riÃªng biá»‡t.
    """
    try:
        # Config vá»›i thread_id Ä‘á»ƒ LangGraph biáº¿t load state nÃ o
        config = {
            "configurable": {
                "thread_id": request.thread_id
            }
        }
        
        # Invoke graph vá»›i checkpoint
        result = graph_app.invoke(
            {"messages": [HumanMessage(content=request.message)]},
            config=config
        )
        
        # Láº¥y response cuá»‘i cÃ¹ng
        last_message = result["messages"][-1]
        
        return ChatResponse(
            response=last_message.content,
            thread_id=request.thread_id
        )
        
    except Exception as e:
        # 2. Äáº£m báº£o báº¡n cÃ³ nhá»¯ng dÃ²ng nÃ y Ä‘á»ƒ in lá»—i chi tiáº¿t
        print("\n--- TRACEBACK Lá»–I CHI TIáº¾T ---")
        traceback.print_exc()
        print("------------------------------\n")
        
        # 3. DÃ²ng raise HTTPException pháº£i náº±m cuá»‘i cÃ¹ng
        raise HTTPException(status_code=500, detail=str(e))

@fastapi_app.get("/history/{thread_id}")
async def get_conversation_history(thread_id: str):
    """
    Láº¥y lá»‹ch sá»­ há»™i thoáº¡i cá»§a má»™t thread_id
    """
    try:
        config = {"configurable": {"thread_id": thread_id}}
        
        # Láº¥y state hiá»‡n táº¡i tá»« checkpoint
        state = graph_app.get_state(config)
        
        if state and state.values.get("messages"):
            messages = state.values["messages"]
            return {
                "thread_id": thread_id,
                "messages": [
                    {
                        "type": type(msg).__name__,
                        "content": msg.content
                    }
                    for msg in messages
                ]
            }
        else:
            return {"thread_id": thread_id, "messages": []}
            
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@fastapi_app.delete("/history/{thread_id}")
async def clear_conversation(thread_id: str):
    """
    XÃ³a lá»‹ch sá»­ há»™i thoáº¡i cá»§a má»™t thread_id
    """
    try:
        # Trong SQLite checkpoint, khÃ´ng cÃ³ API trá»±c tiáº¿p Ä‘á»ƒ xÃ³a
        # Báº¡n cÃ³ thá»ƒ táº¡o thread_id má»›i thay vÃ¬ xÃ³a
        return {"message": f"Äá»ƒ báº¯t Ä‘áº§u cuá»™c há»™i thoáº¡i má»›i, hÃ£y dÃ¹ng thread_id khÃ¡c"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\README.md`:

```````md
# CÃ¡ch cháº¡y code backend: python -m uvicorn endpoints:fastapi_app --reload --port 8001

# Fontend: chainlit run app.py -w         
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\requirements.txt`:

```````txt
amadeus==12.0.0
annotated-types==0.7.0
anyio==4.11.0
async-timeout==4.0.3
cachetools==5.5.2
certifi==2025.8.3
charset-normalizer==3.4.3
distro==1.9.0
exceptiongroup==1.3.0
filetype==1.2.0
google-ai-generativelanguage==0.7.0
google-api-core==2.25.1
google-auth==2.40.3
googleapis-common-protos==1.70.0
greenlet==3.2.4
grpcio==1.75.0
grpcio-status==1.75.0
h11==0.16.0
httpcore==1.0.9
httpx==0.28.1
idna==3.10
jiter==0.11.0
jsonpatch==1.33
jsonpointer==3.0.0
langchain==0.3.27
langchain-core==0.3.76
langchain-google-genai==2.1.12
langchain-openai==0.3.33
langchain-text-splitters==0.3.11
langgraph==0.6.7
langgraph-checkpoint==2.1.1
langgraph-prebuilt==0.6.4
langgraph-sdk==0.2.9
langsmith==0.4.31
openai==1.109.1
orjson==3.11.3
ormsgpack==1.10.0
packaging==25.0
proto-plus==1.26.1
protobuf==6.32.1
pyasn1==0.6.1
pyasn1_modules==0.4.2
pydantic==2.11.9
pydantic_core==2.33.2
python-dotenv==1.1.1
PyYAML==6.0.3
regex==2025.9.18
requests==2.32.5
requests-toolbelt==1.0.0
rsa==4.9.1
sniffio==1.3.1
SQLAlchemy==2.0.43
tenacity==9.1.2
tiktoken==0.11.0
tqdm==4.67.1
typing-inspection==0.4.1
typing_extensions==4.15.0
urllib3==2.5.0
xxhash==3.5.0
zstandard==0.25.0
langchain_google_vertexai
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\booking.py`:

```````py
import json
from langchain_core.messages import SystemMessage, HumanMessage, ToolMessage, AIMessage
from pydantic import BaseModel, Field
from typing import Optional, List

from ..graph.state import AgentState
from ..config import llm
from ..tools.booking_tools import search_flights_tool
from .utils import get_iata_code, convert_relative_date, filter_for_human_ai

class FlightInfoExtractor(BaseModel):
    """TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng."""
    departure_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘i")
    destination_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘áº¿n")
    departure_date: Optional[str] = Field(None, description="NgÃ y Ä‘i, vÃ­ dá»¥: 'hÃ´m nay', 'ngÃ y mai', '25/12'")
    passenger_count: Optional[int] = Field(None, description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n")

# --- Pydantic model Ä‘á»ƒ hiá»ƒu lá»±a chá»n chuyáº¿n bay ---
class FlightChoice(BaseModel):
    """XÃ¡c Ä‘á»‹nh lá»±a chá»n chuyáº¿n bay cá»§a ngÆ°á»i dÃ¹ng tá»« má»™t danh sÃ¡ch."""
    choice_index: Optional[int] = Field(None, description="Chá»‰ sá»‘ (báº¯t Ä‘áº§u tá»« 1) cá»§a chuyáº¿n bay ngÆ°á»i dÃ¹ng chá»n.")
    is_confirmed: bool = Field(False, description="True náº¿u ngÆ°á»i dÃ¹ng cháº¯c cháº¯n chá»n chuyáº¿n bay.")

# --- Pydantic model Má»šI Ä‘á»ƒ trÃ­ch xuáº¥t thÃ´ng tin hÃ nh khÃ¡ch ---
class PassengerInfo(BaseModel):
    """ThÃ´ng tin chi tiáº¿t cá»§a má»™t hÃ nh khÃ¡ch."""
    full_name: str = Field(description="Há» vÃ  tÃªn Ä‘áº§y Ä‘á»§ cá»§a hÃ nh khÃ¡ch, viáº¿t khÃ´ng dáº¥u. VÃ­ dá»¥: Nguyen Van A")
    date_of_birth: str = Field(description="NgÃ y thÃ¡ng nÄƒm sinh theo Ä‘á»‹nh dáº¡ng DD/MM/YYYY. VÃ­ dá»¥: 25/12/1990")
    phone_number: str = Field(description="Sá»‘ Ä‘iá»‡n thoáº¡i liÃªn láº¡c. VÃ­ dá»¥: 0987654321")

class PassengerInfoExtractor(BaseModel):
    """TrÃ­ch xuáº¥t danh sÃ¡ch thÃ´ng tin cá»§a má»™t hoáº·c nhiá»u hÃ nh khÃ¡ch."""
    passengers: List[PassengerInfo] = Field(description="Danh sÃ¡ch thÃ´ng tin cÃ¡c hÃ nh khÃ¡ch Ä‘Æ°á»£c cung cáº¥p.")

# --- LLM vÃ  System Prompt ---
booking_llm = llm.bind_tools([search_flights_tool])
SYSTEM_PROMPT = """Báº¡n lÃ  **Vivi**, má»™t trá»£ lÃ½ áº£o chuyÃªn há»— trá»£ nhá»¯ng váº¥n Ä‘á» liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ© mÃ¡y bay.
        LuÃ´n giao tiáº¿p thÃ¢n thiá»‡n, gá»i khÃ¡ch lÃ  anh/chá»‹ vÃ  xÆ°ng em.
        LuÃ´n tuÃ¢n thá»§ cháº·t cháº½ quy trÃ¬nh nghiá»‡p vá»¥ tá»«ng bÆ°á»›c.
        Khi nháº­n Ä‘Æ°á»£c káº¿t quáº£ tá»« tool, hÃ£y tÃ³m táº¯t nÃ³ cho ngÆ°á»i dÃ¹ng vÃ  Ä‘á» xuáº¥t bÆ°á»›c tiáº¿p theo.
        Náº¿u yÃªu cáº§u cá»§a khÃ¡ch hÃ ng khÃ´ng liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ©, hÃ£y nÃ³i chÃ­nh xÃ¡c cÃ¢u: "Vá» váº¥n Ä‘á» nÃ y, em xin phÃ©p chuyá»ƒn cho má»™t chuyÃªn viÃªn khÃ¡c." vÃ  khÃ´ng lÃ m gÃ¬ thÃªm.
"""

def booking_node(state: AgentState) -> dict:
    """
    Node xá»­ lÃ½ toÃ n bá»™ nghiá»‡p vá»¥ Ä‘áº·t vÃ© mÃ¡y bay má»™t cÃ¡ch tuáº§n tá»±.
    (PhiÃªn báº£n tÃ¡i cáº¥u trÃºc vá»›i logic if/elif/else Ä‘á»ƒ sá»­a lá»—i vÃ²ng láº·p)
    """
    print("---NODE: BOOKING---")
    messages = list(state['messages'])
    current_agent = "booking_agent"

    # ==============================================================================
    # Æ¯U TIÃŠN 1: Xá»­ lÃ½ káº¿t quáº£ vá»«a nháº­n Ä‘Æ°á»£c tá»« Tool
    # ==============================================================================
    if isinstance(messages[-1], ToolMessage):
        print(">>> Booking Node [State 1]: Äang xá»­ lÃ½ káº¿t quáº£ tá»« Tool...")
        try:
            search_results_data = json.loads(messages[-1].content)
        except (json.JSONDecodeError, TypeError):
            search_results_data = {"error": "Dá»¯ liá»‡u tráº£ vá» tá»« tool khÃ´ng há»£p lá»‡."}

        prompt = HumanMessage(
            content=f"""Dá»±a vÃ o káº¿t quáº£ tá»« tool call sau Ä‘Ã¢y:
            ---
            {json.dumps(search_results_data, ensure_ascii=False, indent=2)}
            ---
            HÃ£y tÃ³m táº¯t káº¿t quáº£ cho ngÆ°á»i dÃ¹ng dÆ°á»›i dáº¡ng danh sÃ¡ch gáº¡ch Ä‘áº§u dÃ²ng, má»—i chuyáº¿n bay gá»“m: MÃ£ hiá»‡u, giá» cáº¥t cÃ¡nh, giá» háº¡ cÃ¡nh, vÃ  giÃ¡ vÃ©.
            ÄÃ¡nh sá»‘ thá»© tá»± cho cÃ¡c chuyáº¿n bay báº¯t Ä‘áº§u tá»« 1. Sau Ä‘Ã³ há»i há» muá»‘n chá»n chuyáº¿n bay nÃ o.
            """
        )
        response = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), prompt])
        
        # **Sá»¬A Lá»–I Táº I ÄÃ‚Y:** Tráº£ vá» má»™t dictionary chá»‰ chá»©a cÃ¡c trÆ°á»ng cáº§n cáº­p nháº­t
        # LangGraph sáº½ tá»± Ä‘á»™ng merge dict nÃ y vÃ o state chung.
        return {
            "messages": [response],
            "search_results": search_results_data, # Quan trá»ng nháº¥t lÃ  bÆ°á»›c nÃ y
            "previous_agent": current_agent
        }

    # ==============================================================================
    # Æ¯U TIÃŠN 2: ÄÃ£ cÃ³ káº¿t quáº£, xá»­ lÃ½ lá»±a chá»n chuyáº¿n bay cá»§a ngÆ°á»i dÃ¹ng
    # ==============================================================================
    elif state.get("search_results"):
        print(">>> Booking Node [State 2]: ÄÃ£ cÃ³ káº¿t quáº£, xá»­ lÃ½ lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng...")
        
        # DÃ¹ng LLM cÃ³ cáº¥u trÃºc Ä‘á»ƒ hiá»ƒu lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng
        structured_llm_choice = llm.with_structured_output(FlightChoice)
        choice_prompt = f"""DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch cÃ¡c chuyáº¿n bay Ä‘Ã£ Ä‘Æ°á»£c cung cáº¥p (Ä‘Ã¡nh sá»‘ tá»« 1):
        {json.dumps(state["search_results"], ensure_ascii=False, indent=2)}

        VÃ  Ä‘Ã¢y lÃ  pháº£n há»“i cá»§a ngÆ°á»i dÃ¹ng: "{messages[-1].content}"

        Dá»±a vÃ o pháº£n há»“i, hÃ£y xÃ¡c Ä‘á»‹nh xem ngÆ°á»i dÃ¹ng Ä‘Ã£ chá»n chuyáº¿n bay nÃ o (dá»±a trÃªn sá»‘ thá»© tá»±) vÃ  Ä‘Ã£ xÃ¡c nháº­n lá»±a chá»n Ä‘Ã³ chÆ°a.
        """
        user_choice = structured_llm_choice.invoke(choice_prompt)

        # Náº¿u ngÆ°á»i dÃ¹ng Ä‘Ã£ chá»n vÃ  xÃ¡c nháº­n
        if user_choice.is_confirmed and user_choice.choice_index is not None and 1 <= user_choice.choice_index <= len(state["search_results"]):
            # Trá»« 1 vÃ¬ index cá»§a list báº¯t Ä‘áº§u tá»« 0
            chosen_flight = state["search_results"][user_choice.choice_index - 1]
            
            passenger_count = state.get("passenger_count", 1)
            instructional_prompt = HumanMessage(
                content=f"""
                [Instruction] NgÆ°á»i dÃ¹ng vá»«a chá»n chuyáº¿n bay sau Ä‘Ã¢y:
                {json.dumps(chosen_flight, ensure_ascii=False, indent=2)}

                Nhiá»‡m vá»¥ cá»§a báº¡n bÃ¢y giá» lÃ :
                1. DÃ¹ng vÄƒn phong thÃ¢n thiá»‡n, xÃ¡c nháº­n láº¡i vá»›i ngÆ°á»i dÃ¹ng ráº±ng báº¡n Ä‘Ã£ ghi nháº­n lá»±a chá»n cá»§a há» (vÃ­ dá»¥: "Dáº¡ em xÃ¡c nháº­n anh/chá»‹ Ä‘Ã£ chá»n chuyáº¿n bay...").
                2. YÃªu cáº§u ngÆ°á»i dÃ¹ng cung cáº¥p thÃ´ng tin cho {passenger_count} hÃ nh khÃ¡ch láº§n lÆ°á»£t bao gá»“m: Há» vÃ  tÃªn, NgÃ y sinh (theo Ä‘á»‹nh dáº¡ng DD/MM/YYYY), vÃ  Sá»‘ Ä‘iá»‡n thoáº¡i.
                """
            )
            
            # Lá»c tin nháº¯n Ä‘á»ƒ giá»¯ ngá»¯ cáº£nh sáº¡ch vÃ  thÃªm chá»‰ thá»‹ vÃ o cuá»‘i
            filtered_messages = filter_for_human_ai(messages)[-6:]
            final_prompt =  [SystemMessage(content=SYSTEM_PROMPT)] + filtered_messages + [instructional_prompt]
            
            # Gá»i LLM Ä‘á»ƒ táº¡o ra cÃ¢u tráº£ lá»i tá»± nhiÃªn
            response = booking_llm.invoke(final_prompt)
            
            return {
                "messages": [response],
                "confirmed_flight": chosen_flight,
                "search_results": None, # XÃ³a káº¿t quáº£ tÃ¬m kiáº¿m cÅ© Ä‘á»ƒ trÃ¡nh vÃ o láº¡i state nÃ y
                "previous_agent": current_agent
            }
        
        # Náº¿u ngÆ°á»i dÃ¹ng chÆ°a chá»n rÃµ rÃ ng, há»i láº¡i hoáº·c xá»­ lÃ½ cÃ¢u há»i phá»¥
        else:
            response = booking_llm.invoke(filter_for_human_ai(messages)[-6:])
            return {"messages": [response], "previous_agent": current_agent}
        
         # ==============================================================================
    # STATE 4 (ÄÃƒ Sá»¬A Lá»–I TRIá»†T Äá»‚): Thu tháº­p thÃ´ng tin hÃ nh khÃ¡ch
    # ==============================================================================
    elif state.get("confirmed_flight") and len(state.get("passengers", [])) < state.get("passenger_count", 1):
        print(f">>> Booking Node [State 4]: Thu tháº­p thÃ´ng tin hÃ nh khÃ¡ch...")
        
        structured_llm_pax = llm.with_structured_output(PassengerInfoExtractor)
        extractor_prompt = f"TrÃ­ch xuáº¥t toÃ n bá»™ thÃ´ng tin hÃ nh khÃ¡ch tá»« ná»™i dung sau. Input: \"{messages[-1].content}\""
        
        try:
            extracted_data = structured_llm_pax.invoke(extractor_prompt)
            newly_extracted_passengers = [p.dict() for p in extracted_data.passengers]
        except Exception:
            newly_extracted_passengers = []

        if not newly_extracted_passengers:
            response = AIMessage(content="Dáº¡ em chÆ°a nháº­n Ä‘Æ°á»£c thÃ´ng tin hÃ nh khÃ¡ch. Anh/chá»‹ vui lÃ²ng cung cáº¥p láº§n lÆ°á»£t Há» tÃªn, NgÃ y sinh (DD/MM/YYYY), vÃ  Sá»‘ Ä‘iá»‡n thoáº¡i áº¡.")
            updates = {"messages": state["messages"] + [response], "previous_agent": current_agent}
            return {**state, **updates}

        current_passengers = state.get("passengers", [])
        all_passengers = current_passengers + newly_extracted_passengers
        
        remaining = state.get("passenger_count", 1) - len(all_passengers)

        # Ká»ŠCH Báº¢N 1: Váº«n cÃ²n thiáº¿u thÃ´ng tin -> Táº¡o tin nháº¯n vÃ  Dá»ªNG Láº I
        if remaining > 0:
            print(f">>> Booking Node [State 4]: Váº«n cÃ²n thiáº¿u {remaining} hÃ nh khÃ¡ch. YÃªu cáº§u nháº­p thÃªm...")
            response_content = f"Dáº¡ em Ä‘Ã£ ghi nháº­n thÃ´ng tin. Anh/chá»‹ vui lÃ²ng cung cáº¥p thÃ´ng tin cho {remaining} hÃ nh khÃ¡ch cÃ²n láº¡i áº¡."
            response = AIMessage(content=response_content)
            updates = {
                "messages": state["messages"] + [response],
                "passengers": all_passengers,
                "previous_agent": current_agent
            }
            return {**state, **updates}

        # Ká»ŠCH Báº¢N 2: ÄÃ£ thu tháº­p Ä‘á»§ thÃ´ng tin -> KHÃ”NG táº¡o tin nháº¯n vÃ  CHáº Y TIáº¾P
        else:
            ### =================================================================
            ### BÃŠN TRONG ELSE: THá»°C HIá»†N LOGIC Cá»¦A STATE 5
            ### =================================================================
            print(">>> Booking Node [State 5]: ÄÃ£ Ä‘á»§ thÃ´ng tin, báº¯t Ä‘áº§u tá»•ng káº¿t...")
            
            flight_info = state.get("confirmed_flight", {})
            passenger_info = state.get("passengers", [])
            passenger_count = state.get("passenger_count", 1)
            price_per_ticket = flight_info.get("price", 0)
            total_price = price_per_ticket * passenger_count

            instructional_prompt = HumanMessage(content=f"[INSTRUCTION] Báº¡n Ä‘Ã£ thu tháº­p Ä‘á»§ thÃ´ng tin. BÃ¢y giá» lÃ  bÆ°á»›c cuá»‘i cÃ¹ng trÆ°á»›c khi thanh toÃ¡n.\nDá»¯ liá»‡u Ä‘Ã£ thu tháº­p:\n- ThÃ´ng tin chuyáº¿n bay (giÃ¡ nÃ y lÃ  giÃ¡ cho 1 ngÆ°á»i): {json.dumps(flight_info, ensure_ascii=False, indent=2)}\n- ThÃ´ng tin hÃ nh khÃ¡ch: {json.dumps(passenger_info, ensure_ascii=False, indent=2)}\n- Sá»‘ lÆ°á»£ng vÃ©: {passenger_count}\n- **Tá»”NG CHI PHÃ CUá»I CÃ™NG (ÄÃƒ TÃNH TOÃN): {total_price} VND**\n\nNhiá»‡m vá»¥ cá»§a báº¡n:\n1. Hiá»ƒn thá»‹ láº¡i **TOÃ€N Bá»˜** thÃ´ng tin Ä‘áº·t vÃ© trÃªn cho ngÆ°á»i dÃ¹ng má»™t cÃ¡ch rÃµ rÃ ng, máº¡ch láº¡c, chuyÃªn nghiá»‡p.\n2. **QUAN TRá»ŒNG:** Khi hiá»ƒn thá»‹ pháº§n 'Tá»•ng chi phÃ­', hÃ£y sá»­ dá»¥ng con sá»‘ **Tá»”NG CHI PHÃ CUá»I CÃ™NG** Ä‘Ã£ Ä‘Æ°á»£c tÃ­nh toÃ¡n á»Ÿ trÃªn, khÃ´ng dÃ¹ng giÃ¡ vÃ© trong 'ThÃ´ng tin chuyáº¿n bay'.\n3. YÃªu cáº§u ngÆ°á»i dÃ¹ng kiá»ƒm tra láº¡i tháº­t ká»¹ cÃ¡c thÃ´ng tin.\n4. **Báº®T BUá»˜C** pháº£i yÃªu cáº§u ngÆ°á»i dÃ¹ng pháº£n há»“i chÃ­nh xÃ¡c báº±ng tá»« `xÃ¡c nháº­n` Ä‘á»ƒ tiáº¿p tá»¥c.")
            final_prompt = [SystemMessage(content=SYSTEM_PROMPT)] + filter_for_human_ai(messages)[-6:] + [instructional_prompt]
            response = booking_llm.invoke(final_prompt)
            updates = {"messages": state["messages"] + [response], "final_confirmation_sent": True, "previous_agent": current_agent}
            return {**state, **updates}
  
    # ==============================================================================
    # Æ¯U TIÃŠN 3 (CUá»I CÃ™NG): Thu tháº­p thÃ´ng tin vÃ  kÃ­ch hoáº¡t tÃ¬m kiáº¿m má»›i
    # ==============================================================================
    else:
        print(">>> Booking Node [State 3]: Thu tháº­p thÃ´ng tin...")
        structured_llm = llm.with_structured_output(FlightInfoExtractor)
        extractor_prompt = f"TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« cÃ¢u sau. Input: \"{messages[-1].content}\""
        extracted_info = structured_llm.invoke(extractor_prompt)

        # Táº¡o má»™t dictionary Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin
        updates = {}
        if extracted_info.departure_city: updates["departure_from"] = get_iata_code(extracted_info.departure_city)
        if extracted_info.destination_city: updates["arrival_to"] = get_iata_code(extracted_info.destination_city)
        if extracted_info.departure_date: updates["departure_date"] = convert_relative_date(extracted_info.departure_date)
        if extracted_info.passenger_count: updates["passenger_count"] = extracted_info.passenger_count

        # Láº¥y thÃ´ng tin hiá»‡n táº¡i tá»« state vÃ  cáº­p nháº­t nÃ³
        current_info = {
            "departure_from": state.get("departure_from"),
            "arrival_to": state.get("arrival_to"),
            "departure_date": state.get("departure_date"),
            "passenger_count": state.get("passenger_count"),
        }
        current_info.update(updates)

        if all(current_info.values()):
            print(">>> Booking Node: Äá»§ thÃ´ng tin, chuáº©n bá»‹ gá»i Tool tÃ¬m kiáº¿m...")
            tool_input_message = HumanMessage(content=f"TÃ¬m chuyáº¿n bay tá»« {current_info['departure_from']} Ä‘áº¿n {current_info['arrival_to']} vÃ o ngÃ y {current_info['departure_date']} cho {current_info['passenger_count']} hÃ nh khÃ¡ch.")
            response_with_tool_call = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), tool_input_message])
            
            # Cáº­p nháº­t state vá»›i thÃ´ng tin Ä‘Ã£ thu tháº­p vÃ  tool call
            return {**updates, "messages": [response_with_tool_call], "previous_agent": current_agent}
        
        required_info_map = {"Ä‘iá»ƒm Ä‘i": "departure_from", "Ä‘iá»ƒm Ä‘áº¿n": "arrival_to", "ngÃ y Ä‘i": "departure_date", "sá»‘ lÆ°á»£ng vÃ©": "passenger_count"}
        missing_info = [name for name, key in required_info_map.items() if not current_info.get(key)]

        if missing_info:
            print(f">>> Booking Node: Thiáº¿u thÃ´ng tin: {missing_info}")
            ask_prompt = f"Dáº¡, Ä‘á»ƒ tÃ¬m chuyáº¿n bay, anh/chá»‹ vui lÃ²ng cho em biáº¿t thÃªm vá» {', '.join(missing_info)} áº¡."
            response = AIMessage(content=ask_prompt)
            # Cáº­p nháº­t state vá»›i thÃ´ng tin Ä‘Ã£ cÃ³ vÃ  tin nháº¯n há»i thÃªm
            return {**updates, "messages": [response], "previous_agent": current_agent}

        # TrÆ°á»ng há»£p khÃ´ng thá»ƒ xá»­ lÃ½
        response = AIMessage(content="Dáº¡ em xin lá»—i, em chÆ°a hiá»ƒu rÃµ yÃªu cáº§u cá»§a mÃ¬nh. Anh/chá»‹ cÃ³ thá»ƒ cho em biáº¿t Ä‘iá»ƒm Ä‘i, Ä‘iá»ƒm Ä‘áº¿n vÃ  ngÃ y Ä‘i Ä‘Æ°á»£c khÃ´ng áº¡?")
        return {"messages": [response], "previous_agent": current_agent}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\cancel_booking.py`:

```````py
# src/flight_booking_agent/agents/cancel_booking.py
from langchain_core.messages import AIMessage
from ..graph.state import AgentState

# Giáº£ láº­p cÃ¡c tool cÃ³ thá»ƒ cáº§n
# from ..tools.booking_tools import cancel_booking

# Giáº£ láº­p llm
# from ..config import llm

def cancel_booking_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ nghiá»‡p vá»¥ há»§y vÃ©.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i tool há»§y vÃ©.
    """
    print("---NODE: CANCEL BOOKING (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o
    response_message = AIMessage(content="Dáº¡, Ä‘á»ƒ há»§y vÃ©, anh/chá»‹ vui lÃ²ng cung cáº¥p mÃ£ Ä‘áº·t chá»— áº¡.")
    
    return {
        "messages": [response_message],
        "previous_agent": "cancel_booking_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\general.py`:

```````py
# src/flight_booking_agent/agents/information_gatherer.py
import json
from datetime import datetime, timedelta
from typing import Optional
# Sá»¬A Lá»–I PYDANTIC: Import trá»±c tiáº¿p tá»« pydantic
from pydantic import BaseModel, Field
from langchain_core.messages import SystemMessage, AIMessage, HumanMessage

from ..config import llm
from ..graph.state import AgentState

from .utils import get_iata_code, convert_relative_date


# === THÃŠM HÃ€M Má»šI Táº I ÄÃ‚Y ===
def general_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ cÃ¡c cÃ¢u há»i chung.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i RAG hoáº·c cÃ¡c tool kiáº¿n thá»©c chung.
    """
    print("---NODE: GENERAL (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o chung
    response_message = AIMessage(content="Dáº¡, em cÃ³ thá»ƒ giÃºp gÃ¬ khÃ¡c cho anh/chá»‹ áº¡?")
    
    return {
        "messages": [response_message],
        "previous_agent": "general_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\manager.py`:

```````py
from langchain_core.prompts import ChatPromptTemplate
from pydantic import BaseModel, Field
from typing import Literal
from ..graph.state import AgentState
from ..config import llm

# Pydantic model Ä‘á»ƒ Ä‘á»‹nh nghÄ©a output cÃ³ cáº¥u trÃºc cho Manager
class ManagerHandoff(BaseModel):
    target_agent_name: Literal["booking_agent", "general_agent", "cancel_booking_agent", "END"] = Field(
        ..., description="Agent chuyÃªn trÃ¡ch phÃ¹ há»£p Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u."
    )

def manager_node(state: AgentState) -> dict:
    """
    Node Ä‘iá»u phá»‘i: PhÃ¢n tÃ­ch yÃªu cáº§u vÃ  quyáº¿t Ä‘á»‹nh agent tiáº¿p theo.
    """
    
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system",
             """"## Vai trÃ² ##"
            "Báº¡n lÃ  **Vivi**, lÃ  má»™t trá»£ lÃ½ áº£o Ä‘Ã³ng vai trÃ² Ä‘iá»u phá»‘i viÃªn, "
            "Nhiá»‡m vá»¥ **DUY NHáº¤T** cá»§a báº¡n lÃ  phÃ¢n tÃ­ch yÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng vÃ  "
            "**chuyá»ƒn hÆ°á»›ng chÃ­nh xÃ¡c** Ä‘áº¿n agent chuyÃªn trÃ¡ch phÃ¹ há»£p. "
            "Báº¡n **TUYá»†T Äá»I KHÃ”NG** Ä‘Æ°á»£c tá»± mÃ¬nh tráº£ lá»i báº¥t ká»³ cÃ¢u há»i nÃ o cá»§a khÃ¡ch hÃ ng.\n\n"

            "## CÃ¡c agent chuyÃªn trÃ¡ch & pháº¡m vi xá»­ lÃ½ ##\n"
            "Äá»ƒ phÃ¢n loáº¡i chÃ­nh xÃ¡c, hÃ£y náº¯m rÃµ pháº¡m vi xá»­ lÃ½ cá»§a tá»«ng agent:\n"
            "1. `booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c **TÃŒM KIáº¾M, Lá»°A CHá»ŒN, Äáº¶T MUA** vÃ© mÃ¡y bay vÃ  "
            "cÃ¡c dá»‹ch vá»¥ Ä‘i kÃ¨m (hÃ nh lÃ½, suáº¥t Äƒn, chá»n chá»—) cho má»™t chuyá»ƒn bay cá»¥ thá»ƒ mÃ  khÃ¡ch hÃ ng Ä‘ang quan tÃ¢m hoáº·c muá»‘n Ä‘áº·t.\n"
            "2. `cancel_booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c há»§y bá» má»™t vÃ© Ä‘Ã£ Ä‘áº·t. "
            "YÃªu cáº§u nÃ y thÆ°á»ng bao gá»“m mÃ£ Ä‘áº·t chá»— hoáº·c thÃ´ng tin Ä‘á»§ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh booking cáº§n há»§y.\n"
            "3. `general_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u khÃ¡c náº±m ngoÃ i pháº¡m vi cá»§a cÃ¡c agent trÃªn.\n\n"

            "## Quy táº¯c phÃ¢n loáº¡i vÃ  chuyá»ƒn hÆ°á»›ng ##"
            "PhÃ¢n tÃ­ch **Ã½ Ä‘á»‹nh** cá»§a ngÆ°á»i dÃ¹ng má»™t cÃ¡ch cáº©n tháº­n vÃ  Ã¡p dá»¥ng quy táº¯c sau Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tÃ¡c tá»­ Ä‘Ã­ch:\n"
            "1. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **Há»¦Y** vÃ© -> chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `cancel_booking_agent`.\n"
            "2. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **TÃŒM, CHá»ŒN, Äáº¶T MUA**` má»™t chuyáº¿n bay hoáº·c dá»‹ch vá»¥ Ä‘i kÃ¨m -> "
            "chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `booking_agent`.\n"
            "3. Trong **Táº¤T Cáº¢ cÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i** (bao gá»“m há»i thÃ´ng tin chung, quy Ä‘á»‹nh, thá»§ tá»¥c, chÃ o há»i, "
            "cÃ¡c yÃªu cáº§u khÃ´ng rÃµ rÃ ng hoáº·c khÃ´ng liÃªn quan Ä‘áº¿n viá»‡c Ä‘áº·t/há»§y cá»¥ thá»ƒ) -> Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `general_agent`"

            "## LÆ°u Ã½ quan trá»ng ##\n"
            "Báº¡n **PHáº¢I LUÃ”N** pháº£n há»“i dÆ°á»›i dáº¡ng cáº¥u trÃºc `ManagerHandoff`"
        )"""),
            ("user", "YÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng: {input}"),
        ]
    )

    # Sá»­ dá»¥ng .with_structured_output Ä‘á»ƒ Ä‘áº£m báº£o LLM tráº£ vá» Ä‘Ãºng format
    structured_llm = llm.with_structured_output(ManagerHandoff)
    
    chain = prompt | structured_llm
    
    # Chá»‰ láº¥y tin nháº¯n cuá»‘i cÃ¹ng cá»§a ngÆ°á»i dÃ¹ng Ä‘á»ƒ phÃ¢n tÃ­ch
    user_input = state['messages'][-1].content
    result = chain.invoke({"input": user_input})
    
    return {"next_agent": result.target_agent_name}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\router.py`:

```````py
from ..graph.state import AgentState

SPECIALIST_AGENTS = ["booking_agent", "cancel_booking_agent", "general_agent"]

def proxy_router_node(state: AgentState) -> dict:
    previous_agent = state.get("previous_agent")

    # Náº¿u chÆ°a tá»«ng gá»i agent nÃ o â†’ Ä‘i qua manager
    if previous_agent is None:
        return {"next_agent": "manager"}

    # Náº¿u Ä‘Ã£ cÃ³ agent vÃ  agent Ä‘Ã³ thuá»™c nhÃ³m chuyÃªn trÃ¡ch â†’ quay láº¡i Ä‘Ãºng agent Ä‘Ã³
    if previous_agent in SPECIALIST_AGENTS:
        return {"next_agent": previous_agent}

    # Máº·c Ä‘á»‹nh â†’ váº«n vá» manager
    return {"next_agent": "manager"}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\utils.py`:

```````py
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from typing import List
from datetime import datetime, timedelta
import re

AIRPORT_MAP = {
    # Viá»‡t Nam
    'hÃ  ná»™i': 'HAN', 'hanoi': 'HAN', 'ná»™i bÃ i': 'HAN',
    'há»“ chÃ­ minh': 'SGN', 'ho chi minh': 'SGN', 'hcm': 'SGN',
    'sÃ i gÃ²n': 'SGN', 'sai gon': 'SGN', 'tÃ¢n sÆ¡n nháº¥t': 'SGN',
    'Ä‘Ã  náºµng': 'DAD', 'da nang': 'DAD',
    'háº£i phÃ²ng': 'HPH', 'cat bi': 'HPH',
    'huáº¿': 'HUI', 'phÃº bÃ i': 'HUI',
    'nha trang': 'CXR', 'cam ranh': 'CXR',
    'phÃº quá»‘c': 'PQC', 'phu quoc': 'PQC',
    'cáº§n thÆ¡': 'VCA', 'can tho': 'VCA',

    # ÄÃ´ng Nam Ã
    'bangkok': 'BKK', 'suvarnabhumi': 'BKK',
    'don muang': 'DMK',
    'singapore': 'SIN', 'changi': 'SIN',
    'kuala lumpur': 'KUL',
    'jakarta': 'CGK',
    'manila': 'MNL',
    'phnom penh': 'PNH',
    'siem reap': 'REP',

    # ÄÃ´ng Ã
    'tokyo': 'NRT', 'narita': 'NRT',
    'haneda': 'HND',
    'osaka': 'KIX',
    'seoul': 'ICN', 'incheon': 'ICN',
    'busan': 'PUS',
    'Ä‘Ã i báº¯c': 'TPE', 'taipei': 'TPE',
    'hong kong': 'HKG',
    'thÆ°á»£ng háº£i': 'PVG', 'shanghai': 'PVG',
    'báº¯c kinh': 'PEK', 'beijing': 'PEK',

    # Trung ÄÃ´ng
    'dubai': 'DXB',
    'abu dhabi': 'AUH',
    'doha': 'DOH',
    'istanbul': 'IST',

    # ChÃ¢u Ã‚u
    'london': 'LHR', 'heathrow': 'LHR',
    'paris': 'CDG', 'charles de gaulle': 'CDG',
    'frankfurt': 'FRA',
    'munich': 'MUC',
    'madrid': 'MAD',
    'barcelona': 'BCN',
    'rome': 'FCO', 'fiumicino': 'FCO',
    'amsterdam': 'AMS',
    'zurich': 'ZRH',
    'vienna': 'VIE',

    # Báº¯c Má»¹
    'new york': 'JFK', 'jfk': 'JFK',
    'los angeles': 'LAX', 'la': 'LAX',
    'san francisco': 'SFO',
    'chicago': 'ORD',
    'toronto': 'YYZ',
    'vancouver': 'YVR',

    # Ãšc
    'sydney': 'SYD',
    'melbourne': 'MEL',
    'brisbane': 'BNE'
}


def get_iata_code(location_name: str) -> str | None:
    if not location_name: return None
    normalized = location_name.lower().strip()
    
    # Náº¿u ngÆ°á»i dÃ¹ng nháº­p tháº³ng mÃ£ IATA (3 chá»¯ cÃ¡i)
    if len(normalized) == 3 and normalized.isalpha():
        return normalized.upper()
        
    return AIRPORT_MAP.get(normalized)

def convert_relative_date(date_str: str) -> str:
    """
    Chuyá»ƒn Ä‘á»•i cÃ¡c ngÃ y tÆ°Æ¡ng Ä‘á»‘i hoáº·c Ä‘á»‹nh dáº¡ng dd/mm sang Ä‘á»‹nh dáº¡ng 'YYYY-MM-DD'.

    Supported:
        - "hÃ´m nay"
        - "ngÃ y mai"
        - "ngÃ y má»‘t"
        - "dd/mm" hoáº·c "dd-mm"
        - "YYYY-mm-dd" (tráº£ vá» nguyÃªn báº£n náº¿u Ä‘Ãºng Ä‘á»‹nh dáº¡ng)
    """
    date_str = date_str.strip().lower()
    today = datetime.now()

    if date_str in ["hÃ´m nay", "hom nay"]:
        return today.strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y mai", "ngay mai"]:
        return (today + timedelta(days=1)).strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y má»‘t", "ngay mot"]:
        return (today + timedelta(days=2)).strftime("%Y-%m-%d")
    
    # Kiá»ƒm tra Ä‘á»‹nh dáº¡ng dd/mm hoáº·c dd-mm
    match = re.match(r"(\d{1,2})[/-](\d{1,2})", date_str)
    if match:
        day, month = map(int, match.groups())
        year = today.year
        try:
            dt = datetime(year, month, day)
            # Náº¿u ngÃ y Ä‘Ã£ qua trong nÄƒm hiá»‡n táº¡i, tá»± Ä‘á»™ng láº¥y nÄƒm sau
            if dt < today:
                dt = datetime(year + 1, month, day)
            return dt.strftime("%Y-%m-%d")
        except ValueError:
            raise ValueError(f"NgÃ y khÃ´ng há»£p lá»‡: {date_str}")

    # Kiá»ƒm tra xem cÃ³ pháº£i lÃ  ISO format YYYY-MM-DD khÃ´ng
    try:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        return dt.strftime("%Y-%m-%d")
    except ValueError:
        pass

    raise ValueError(f"KhÃ´ng thá»ƒ nháº­n dáº¡ng ngÃ y: {date_str}")

# Xá»­ lÃ­ tin nháº¯n há»™i thoáº¡i
def filter_for_human_ai(messages: List[BaseMessage]) -> List[BaseMessage]:
    """
    Lá»c lá»‹ch sá»­ há»™i thoáº¡i, chá»‰ giá»¯ láº¡i cÃ¡c tin nháº¯n tá»« ngÆ°á»i dÃ¹ng (HumanMessage)
    vÃ  cÃ¡c tin nháº¯n tráº£ lá»i cÃ³ ná»™i dung cá»§a AI (AIMessage).
    
    Loáº¡i bá»:
    - ToolMessage (káº¿t quáº£ tá»« tool)
    - AIMessage khÃ´ng cÃ³ ná»™i dung (thÆ°á»ng lÃ  cÃ¡c tin nháº¯n chá»©a tool_calls)
    """
    filtered_messages = []
    for m in messages:
        # Giá»¯ láº¡i táº¥t cáº£ HumanMessage
        if isinstance(m, HumanMessage):
            filtered_messages.append(m)
        # Chá»‰ giá»¯ láº¡i AIMessage náº¿u nÃ³ cÃ³ ná»™i dung vÄƒn báº£n Ä‘á»ƒ trÃ² chuyá»‡n
        elif isinstance(m, AIMessage) and m.content:
            filtered_messages.append(m)
    return filtered_messages
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\config.py`:

```````py
# src/flight_booking_agent/config.py
import os
from dotenv import load_dotenv
# Thay Ä‘á»•i import
from langchain_google_vertexai import ChatVertexAI



load_dotenv()
llm = ChatVertexAI(
    model_name="gemini-2.5-pro", 
    temperature=0.7,
    project="end-to-end-agentic-rag",  
    location="us-central1",     
)



```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\state.py`:

```````py
from typing import List, TypedDict, Annotated, Optional, Literal
from langchain_core.messages import BaseMessage
import operator

class AgentState(TypedDict):
    """
    Tráº¡ng thÃ¡i chung cho há»‡ thá»‘ng Multi-Agent, Ä‘Æ°á»£c chia sáº» qua táº¥t cáº£ cÃ¡c node.

    Attributes:
        messages: Lá»‹ch sá»­ há»™i thoáº¡i.
        next_agent: Agent tiáº¿p theo Ä‘Æ°á»£c gá»i, do Manager quyáº¿t Ä‘á»‹nh.
        ... cÃ¡c trÆ°á»ng dá»¯ liá»‡u khÃ¡c Ä‘Æ°á»£c thu tháº­p trong quÃ¡ trÃ¬nh ...
    """
    # Lá»‹ch sá»­ há»™i thoáº¡i
    messages: Annotated[List[BaseMessage], operator.add]

    # TrÆ°á»ng Ä‘iá»u hÆ°á»›ng luá»“ng
    next_agent: Optional[str]
    # LÆ°u láº¡i tÃªn cá»§a agent vá»«a hoáº¡t Ä‘á»™ng á»Ÿ lÆ°á»£t trÆ°á»›c.
    previous_agent: Optional[str]

    # CÃ¡c thÃ´ng tin Ä‘Æ°á»£c thu tháº­p (tÆ°Æ¡ng Ä‘Æ°Æ¡ng BookingDeps)
    airline: Optional[str]
    flight_number: Optional[str]
    departure_from: Optional[str]
    arrival_to: Optional[str]
    departure_date: Optional[str]
    departure_time: Optional[str]
    travel_class: Optional[Literal["ECONOMY", "PREMIUM_ECONOMY", "BUSINESS", "FIRST"]]
    passenger_count: Optional[List[dict]]
    ancillary: Optional[List[dict]]
    original_ticket_price: Optional[str]
    
    # Káº¿t quáº£ tÃ¬m kiáº¿m vÃ  lá»±a chá»n
    search_results: Optional[List[dict]]
    confirmed_flight: Optional[dict]

    # THÃŠM TRÆ¯á»œNG Má»šI Äá»‚ LÆ¯U DANH SÃCH HÃ€NH KHÃCH
    passengers: Optional[List[dict]]
    
     # THÃŠM TRÆ¯á»œNG Má»šI
    final_confirmation_sent: Optional[bool] # Cá» Ä‘á»ƒ Ä‘Ã¡nh dáº¥u Ä‘Ã£ gá»­i xÃ¡c nháº­n cuá»‘i cÃ¹ng
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\workflow.py`:

```````py
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import ToolNode
#from langgraph.checkpoint.sqlite import SqliteSaver  # THÃŠM DÃ’NG NÃ€Y
from langgraph.checkpoint.memory import InMemorySaver
from .state import AgentState
from ..agents import manager, booking, cancel_booking, general, router
from ..tools import booking_tools

# 1. Táº­p há»£p táº¥t cáº£ cÃ¡c tool
all_tools = [
    booking_tools.search_flights_tool,
]
tool_node = ToolNode(all_tools)

# 2. XÃ¢y dá»±ng Ä‘á»“ thá»‹
workflow = StateGraph(AgentState)

# ThÃªm táº¥t cáº£ cÃ¡c node
workflow.add_node("router", router.proxy_router_node)
workflow.add_node("manager", manager.manager_node)
workflow.add_node("booking_agent", booking.booking_node)
workflow.add_node("cancel_booking_agent", cancel_booking.cancel_booking_node)
workflow.add_node("general_agent", general.general_node)
workflow.add_node("tools", tool_node)

# 3. Äá»‹nh nghÄ©a cÃ¡c cáº¡nh (giá»¯ nguyÃªn code cÅ© cá»§a báº¡n)
workflow.set_entry_point("router")

workflow.add_conditional_edges(
    "router",
    lambda state: state["next_agent"],
    {
        "manager": "manager",
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
    }
)

def route_from_manager(state: AgentState):
    next_agent = state.get("next_agent")
    return next_agent

workflow.add_conditional_edges("manager", route_from_manager)

def route_after_task(state: AgentState):
    last_message = state['messages'][-1]
    if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
        return "tools"
    if state.get("next_agent") == "manager":
        return "manager"
    return END

workflow.add_conditional_edges("booking_agent", route_after_task)
workflow.add_conditional_edges("cancel_booking_agent", route_after_task)
workflow.add_conditional_edges("general_agent", route_after_task)

def route_after_tools(state: AgentState) -> str:
    previous_agent = state.get("previous_agent")
    if previous_agent:
        print(f">>> Tool execution finished. Returning to: {previous_agent}")
        return previous_agent
    else:
        return "manager"

workflow.add_conditional_edges(
    "tools",
    route_after_tools,
    {
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
    }
)

# 4. âœ… THÃŠM CHECKPOINT VÃ€O ÄÃ‚Y

checkpointer = InMemorySaver()
app = workflow.compile(checkpointer=checkpointer)



try:
    app.get_graph().draw_mermaid_png(output_file_path="D:\\Project\\-n-T-t-Nghi-p-\\img\\workflow_graph.png")
    print("ÄÃ£ váº½ sÆ¡ Ä‘á»“ workflow ra file: workflow_graph.png")
except Exception as e:
    print(f"KhÃ´ng thá»ƒ váº½ Ä‘á»“ thá»‹: {e}")
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\__init__.py`:

```````py
from .state import AgentState
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\output.txt`:

```````txt
Project Path: \\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent

Source Tree:

```
flight_booking_agent
â”œâ”€â”€ agents
â”‚   â”œâ”€â”€ booking.py
â”‚   â”œâ”€â”€ cancel_booking.py
â”‚   â”œâ”€â”€ general.py
â”‚   â”œâ”€â”€ manager.py
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ utils.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ booking.cpython-310.pyc
â”‚       â”œâ”€â”€ booking_manager.cpython-310.pyc
â”‚       â”œâ”€â”€ cancel_booking.cpython-310.pyc
â”‚       â”œâ”€â”€ flight_searcher.cpython-310.pyc
â”‚       â”œâ”€â”€ general.cpython-310.pyc
â”‚       â”œâ”€â”€ information_gatherer.cpython-310.pyc
â”‚       â”œâ”€â”€ manager.cpython-310.pyc
â”‚       â”œâ”€â”€ recommendation.cpython-310.pyc
â”‚       â”œâ”€â”€ router.cpython-310.pyc
â”‚       â”œâ”€â”€ utils.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ endpoints.py
â”‚   â”œâ”€â”€ schemas.py
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ config.py
â”œâ”€â”€ graph
â”‚   â”œâ”€â”€ state.py
â”‚   â”œâ”€â”€ workflow.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ state.cpython-310.pyc
â”‚       â”œâ”€â”€ workflow.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ output.txt
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ amadeus_client.py
â”‚   â”œâ”€â”€ payment_client.py
â”‚   â”œâ”€â”€ skyscanner_client.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ amadeus_client.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ tools
â”‚   â”œâ”€â”€ booking_tools.py
â”‚   â”œâ”€â”€ cancel_tools.py
â”‚   â”œâ”€â”€ general_tools.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ booking_tools.cpython-310.pyc
â”‚       â”œâ”€â”€ flight_tools.cpython-310.pyc
â”‚       â”œâ”€â”€ general_tools.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ __init__.py
â””â”€â”€ __pycache__
    â”œâ”€â”€ config.cpython-310.pyc
    â””â”€â”€ __init__.cpython-310.pyc

```

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\booking.py`:

```````py
import json
from langchain_core.messages import SystemMessage, HumanMessage, ToolMessage, AIMessage
from pydantic import BaseModel, Field
from typing import Optional, List

from ..graph.state import AgentState
from ..config import llm
from ..tools.booking_tools import search_flights_tool
from .utils import get_iata_code, convert_relative_date, filter_for_human_ai

# --- Pydantic model Ä‘á»ƒ trÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay ---
class FlightInfoExtractor(BaseModel):
    """TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng."""
    departure_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘i")
    destination_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘áº¿n")
    departure_date: Optional[str] = Field(None, description="NgÃ y Ä‘i, vÃ­ dá»¥: 'hÃ´m nay', 'ngÃ y mai', '25/12'")
    passenger_count: Optional[int] = Field(None, description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n")

### =================================================================
### LOGIC Má»šI: Pydantic Model Ä‘á»ƒ hiá»ƒu lá»±a chá»n chuyáº¿n bay cá»§a ngÆ°á»i dÃ¹ng
### =================================================================
class FlightChoice(BaseModel):
    """XÃ¡c Ä‘á»‹nh lá»±a chá»n chuyáº¿n bay cá»§a ngÆ°á»i dÃ¹ng tá»« má»™t danh sÃ¡ch."""
    choice_index: Optional[int] = Field(
        None, 
        description="Chá»‰ sá»‘ (index, báº¯t Ä‘áº§u tá»« 1) cá»§a chuyáº¿n bay ngÆ°á»i dÃ¹ng chá»n. VÃ­ dá»¥: náº¿u ngÆ°á»i dÃ¹ng nÃ³i 'chuyáº¿n thá»© hai' hoáº·c 'chuyáº¿n sá»‘ 2', giÃ¡ trá»‹ lÃ  2."
    )
    is_confirmed: bool = Field(
        False, 
        description="True náº¿u ngÆ°á»i dÃ¹ng cháº¯c cháº¯n chá»n chuyáº¿n bay nÃ y, vÃ­ dá»¥: 'tÃ´i chá»n chuyáº¿n nÃ y', 'láº¥y cho tÃ´i chuyáº¿n 3'."
    )

# --- LLM vÃ  System Prompt ---
booking_llm = llm.bind_tools([search_flights_tool])
SYSTEM_PROMPT = """Báº¡n lÃ  **Vivi**, má»™t trá»£ lÃ½ áº£o chuyÃªn há»— trá»£ nhá»¯ng váº¥n Ä‘á» liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ© mÃ¡y bay.
        LuÃ´n giao tiáº¿p thÃ¢n thiá»‡n, gá»i khÃ¡ch lÃ  anh/chá»‹ vÃ  xÆ°ng em.
        LuÃ´n tuÃ¢n thá»§ cháº·t cháº½ quy trÃ¬nh nghiá»‡p vá»¥ tá»«ng bÆ°á»›c.
        Khi nháº­n Ä‘Æ°á»£c káº¿t quáº£ tá»« tool, hÃ£y tÃ³m táº¯t nÃ³ cho ngÆ°á»i dÃ¹ng vÃ  Ä‘á» xuáº¥t bÆ°á»›c tiáº¿p theo.
        Náº¿u yÃªu cáº§u cá»§a khÃ¡ch hÃ ng khÃ´ng liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ©, hÃ£y nÃ³i chÃ­nh xÃ¡c cÃ¢u: "Vá» váº¥n Ä‘á» nÃ y, em xin phÃ©p chuyá»ƒn cho má»™t chuyÃªn viÃªn khÃ¡c." vÃ  khÃ´ng lÃ m gÃ¬ thÃªm.
"""

def booking_node(state: AgentState) -> dict:
    """
    Node xá»­ lÃ½ toÃ n bá»™ nghiá»‡p vá»¥ Ä‘áº·t vÃ© mÃ¡y bay má»™t cÃ¡ch tuáº§n tá»±.
    (PhiÃªn báº£n tÃ¡i cáº¥u trÃºc vá»›i logic if/elif/else Ä‘á»ƒ sá»­a lá»—i vÃ²ng láº·p)
    """
    print("---NODE: BOOKING---")
    messages = list(state['messages'])
    current_agent = "booking_agent"

    # ==============================================================================
    # Æ¯U TIÃŠN 1: Xá»­ lÃ½ káº¿t quáº£ vá»«a nháº­n Ä‘Æ°á»£c tá»« Tool
    # ==============================================================================
    if isinstance(messages[-1], ToolMessage):
        print(">>> Booking Node [State 1]: Äang xá»­ lÃ½ káº¿t quáº£ tá»« Tool...")
        try:
            search_results_data = json.loads(messages[-1].content)
        except (json.JSONDecodeError, TypeError):
            search_results_data = {"error": "Dá»¯ liá»‡u tráº£ vá» tá»« tool khÃ´ng há»£p lá»‡."}

        prompt = HumanMessage(
            content=f"""Dá»±a vÃ o káº¿t quáº£ tá»« tool call sau Ä‘Ã¢y:
            ---
            {json.dumps(search_results_data, ensure_ascii=False, indent=2)}
            ---
            HÃ£y tÃ³m táº¯t káº¿t quáº£ cho ngÆ°á»i dÃ¹ng dÆ°á»›i dáº¡ng danh sÃ¡ch gáº¡ch Ä‘áº§u dÃ²ng, má»—i chuyáº¿n bay gá»“m: MÃ£ hiá»‡u, giá» cáº¥t cÃ¡nh, giá» háº¡ cÃ¡nh, vÃ  giÃ¡ vÃ©.
            ÄÃ¡nh sá»‘ thá»© tá»± cho cÃ¡c chuyáº¿n bay báº¯t Ä‘áº§u tá»« 1. Sau Ä‘Ã³ há»i há» muá»‘n chá»n chuyáº¿n bay nÃ o.
            """
        )
        response = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), prompt])
        
        updates = {
            "messages": state["messages"] + [response],
            "search_results": search_results_data,
            "previous_agent": current_agent
        }
        return {**state, **updates}

    # ==============================================================================
    # Æ¯U TIÃŠN 2: ÄÃ£ cÃ³ káº¿t quáº£, xá»­ lÃ½ lá»±a chá»n chuyáº¿n bay cá»§a ngÆ°á»i dÃ¹ng
    # ==============================================================================
    elif state.get("search_results"):
        print(">>> Booking Node [State 2]: ÄÃ£ cÃ³ káº¿t quáº£, xá»­ lÃ½ lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng...")
        
        # DÃ¹ng LLM cÃ³ cáº¥u trÃºc Ä‘á»ƒ hiá»ƒu lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng
        structured_llm_choice = llm.with_structured_output(FlightChoice)
        choice_prompt = f"""DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch cÃ¡c chuyáº¿n bay Ä‘Ã£ Ä‘Æ°á»£c cung cáº¥p (Ä‘Ã¡nh sá»‘ tá»« 1):
        {json.dumps(state["search_results"], ensure_ascii=False, indent=2)}

        VÃ  Ä‘Ã¢y lÃ  pháº£n há»“i cá»§a ngÆ°á»i dÃ¹ng: "{messages[-1].content}"

        Dá»±a vÃ o pháº£n há»“i, hÃ£y xÃ¡c Ä‘á»‹nh xem ngÆ°á»i dÃ¹ng Ä‘Ã£ chá»n chuyáº¿n bay nÃ o (dá»±a trÃªn sá»‘ thá»© tá»±) vÃ  Ä‘Ã£ xÃ¡c nháº­n lá»±a chá»n Ä‘Ã³ chÆ°a.
        """
        user_choice = structured_llm_choice.invoke(choice_prompt)

        # Náº¿u ngÆ°á»i dÃ¹ng Ä‘Ã£ chá»n vÃ  xÃ¡c nháº­n -> Chuyá»ƒn sang State 4
        if user_choice.is_confirmed and user_choice.choice_index is not None and 1 <= user_choice.choice_index <= len(state["search_results"]):
            # Trá»« 1 vÃ¬ index cá»§a list báº¯t Ä‘áº§u tá»« 0
            chosen_flight = state["search_results"][user_choice.choice_index - 1]
            
            passenger_count = state.get("passenger_count", 1)
            response_content = f"""Dáº¡ em Ä‘Ã£ xÃ¡c nháº­n anh/chá»‹ chá»n chuyáº¿n bay:
            - HÃ£ng bay: {chosen_flight.get('airline', 'N/A')}
            - MÃ£ hiá»‡u: {chosen_flight.get('flight_number', 'N/A')}
            - Khá»Ÿi hÃ nh lÃºc: {chosen_flight.get('departure_time', 'N/A')}
            - GiÃ¡ vÃ©: {chosen_flight.get('price', 0):,} {chosen_flight.get('currency', 'VND')}

            Äá»ƒ tiáº¿p tá»¥c, anh/chá»‹ vui lÃ²ng cung cáº¥p thÃ´ng tin cho {passenger_count} hÃ nh khÃ¡ch áº¡ (Há» vÃ  tÃªn, NgÃ y sinh DD/MM/YYYY, SÄT).
            """
            response = AIMessage(content=response_content)
            
            updates = {
                "messages": state["messages"] + [response],
                "confirmed_flight": chosen_flight, # LÆ°u chuyáº¿n bay Ä‘Ã£ chá»n
                "search_results": None, # XÃ³a káº¿t quáº£ tÃ¬m kiáº¿m cÅ© Ä‘á»ƒ trÃ¡nh vÃ o láº¡i state nÃ y
                "previous_agent": current_agent
            }
            return {**state, **updates}
        
        # Náº¿u ngÆ°á»i dÃ¹ng chÆ°a chá»n rÃµ rÃ ng, há»i láº¡i hoáº·c xá»­ lÃ½ cÃ¢u há»i phá»¥
        else:
            # Fallback cho cÃ¡c cÃ¢u há»i phá»¥
            response = booking_llm.invoke(filter_for_human_ai(messages))
            updates = {"messages": state["messages"] + [response], "previous_agent": current_agent}
            return {**state, **updates}

    # ==============================================================================
    # Æ¯U TIÃŠN 3 (CUá»I CÃ™NG): Thu tháº­p thÃ´ng tin vÃ  kÃ­ch hoáº¡t tÃ¬m kiáº¿m má»›i
    # ==============================================================================
    else:
        print(">>> Booking Node [State 3]: Thu tháº­p thÃ´ng tin...")
        structured_llm = llm.with_structured_output(FlightInfoExtractor)
        extractor_prompt = f"TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« cÃ¢u sau. Input: \"{messages[-1].content}\""
        extracted_info = structured_llm.invoke(extractor_prompt)

        current_info = {
            "departure_from": state.get("departure_from"),
            "arrival_to": state.get("arrival_to"),
            "departure_date": state.get("departure_date"),
            "passenger_count": state.get("passenger_count"),
        }

        if extracted_info.departure_city: current_info["departure_from"] = get_iata_code(extracted_info.departure_city)
        if extracted_info.destination_city: current_info["arrival_to"] = get_iata_code(extracted_info.destination_city)
        if extracted_info.departure_date: current_info["departure_date"] = convert_relative_date(extracted_info.departure_date)
        if extracted_info.passenger_count: current_info["passenger_count"] = extracted_info.passenger_count

        if all(current_info.values()):
            print(">>> Booking Node: Äá»§ thÃ´ng tin, chuáº©n bá»‹ gá»i Tool tÃ¬m kiáº¿m...")
            tool_input_message = HumanMessage(content=f"TÃ¬m chuyáº¿n bay tá»« {current_info['departure_from']} Ä‘áº¿n {current_info['arrival_to']} vÃ o ngÃ y {current_info['departure_date']} cho {current_info['passenger_count']} hÃ nh khÃ¡ch.")
            response_with_tool_call = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), tool_input_message])
            
            updates = {**current_info, "messages": state["messages"] + [response_with_tool_call], "previous_agent": current_agent}
            return {**state, **updates}
        
        required_info_map = {"Ä‘iá»ƒm Ä‘i": "departure_from", "Ä‘iá»ƒm Ä‘áº¿n": "arrival_to", "ngÃ y Ä‘i": "departure_date", "sá»‘ lÆ°á»£ng vÃ©": "passenger_count"}
        missing_info = [name for name, key in required_info_map.items() if not current_info.get(key)]

        if missing_info:
            print(f">>> Booking Node: Thiáº¿u thÃ´ng tin: {missing_info}")
            ask_prompt = f"Dáº¡, Ä‘á»ƒ tÃ¬m chuyáº¿n bay, anh/chá»‹ vui lÃ²ng cho em biáº¿t thÃªm vá» {', '.join(missing_info)} áº¡."
            response = AIMessage(content=ask_prompt)
            updates = {**current_info, "messages": state["messages"] + [response], "previous_agent": current_agent}
            return {**state, **updates}

        # TrÆ°á»ng há»£p khÃ´ng thá»ƒ xá»­ lÃ½
        response = AIMessage(content="Dáº¡ em xin lá»—i, em chÆ°a hiá»ƒu rÃµ yÃªu cáº§u cá»§a mÃ¬nh. Anh/chá»‹ cÃ³ thá»ƒ cho em biáº¿t Ä‘iá»ƒm Ä‘i, Ä‘iá»ƒm Ä‘áº¿n vÃ  ngÃ y Ä‘i Ä‘Æ°á»£c khÃ´ng áº¡?")
        updates = {"messages": state["messages"] + [response], "previous_agent": current_agent}
        return {**state, **updates}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\cancel_booking.py`:

```````py
# src/flight_booking_agent/agents/cancel_booking.py
from langchain_core.messages import AIMessage
from ..graph.state import AgentState

# Giáº£ láº­p cÃ¡c tool cÃ³ thá»ƒ cáº§n
# from ..tools.booking_tools import cancel_booking

# Giáº£ láº­p llm
# from ..config import llm

def cancel_booking_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ nghiá»‡p vá»¥ há»§y vÃ©.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i tool há»§y vÃ©.
    """
    print("---NODE: CANCEL BOOKING (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o
    response_message = AIMessage(content="Dáº¡, Ä‘á»ƒ há»§y vÃ©, anh/chá»‹ vui lÃ²ng cung cáº¥p mÃ£ Ä‘áº·t chá»— áº¡.")
    
    return {
        "messages": [response_message],
        "previous_agent": "cancel_booking_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\general.py`:

```````py
# src/flight_booking_agent/agents/information_gatherer.py
import json
from datetime import datetime, timedelta
from typing import Optional
# Sá»¬A Lá»–I PYDANTIC: Import trá»±c tiáº¿p tá»« pydantic
from pydantic import BaseModel, Field
from langchain_core.messages import SystemMessage, AIMessage, HumanMessage

from ..config import llm
from ..graph.state import AgentState

from .utils import get_iata_code, convert_relative_date


# === THÃŠM HÃ€M Má»šI Táº I ÄÃ‚Y ===
def general_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ cÃ¡c cÃ¢u há»i chung.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i RAG hoáº·c cÃ¡c tool kiáº¿n thá»©c chung.
    """
    print("---NODE: GENERAL (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o chung
    response_message = AIMessage(content="Dáº¡, em cÃ³ thá»ƒ giÃºp gÃ¬ khÃ¡c cho anh/chá»‹ áº¡?")
    
    return {
        "messages": [response_message],
        "previous_agent": "general_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\manager.py`:

```````py
from langchain_core.prompts import ChatPromptTemplate
from pydantic import BaseModel, Field
from typing import Literal
from ..graph.state import AgentState
from ..config import llm

# Pydantic model Ä‘á»ƒ Ä‘á»‹nh nghÄ©a output cÃ³ cáº¥u trÃºc cho Manager
class ManagerHandoff(BaseModel):
    target_agent_name: Literal["booking_agent", "general_agent", "cancel_booking_agent", "END"] = Field(
        ..., description="Agent chuyÃªn trÃ¡ch phÃ¹ há»£p Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u."
    )

def manager_node(state: AgentState) -> dict:
    """
    Node Ä‘iá»u phá»‘i: PhÃ¢n tÃ­ch yÃªu cáº§u vÃ  quyáº¿t Ä‘á»‹nh agent tiáº¿p theo.
    """
    
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system",
             """"## Vai trÃ² ##"
            "Báº¡n lÃ  **Vivi**, lÃ  má»™t trá»£ lÃ½ áº£o Ä‘Ã³ng vai trÃ² Ä‘iá»u phá»‘i viÃªn, "
            "Nhiá»‡m vá»¥ **DUY NHáº¤T** cá»§a báº¡n lÃ  phÃ¢n tÃ­ch yÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng vÃ  "
            "**chuyá»ƒn hÆ°á»›ng chÃ­nh xÃ¡c** Ä‘áº¿n agent chuyÃªn trÃ¡ch phÃ¹ há»£p. "
            "Báº¡n **TUYá»†T Äá»I KHÃ”NG** Ä‘Æ°á»£c tá»± mÃ¬nh tráº£ lá»i báº¥t ká»³ cÃ¢u há»i nÃ o cá»§a khÃ¡ch hÃ ng.\n\n"

            "## CÃ¡c agent chuyÃªn trÃ¡ch & pháº¡m vi xá»­ lÃ½ ##\n"
            "Äá»ƒ phÃ¢n loáº¡i chÃ­nh xÃ¡c, hÃ£y náº¯m rÃµ pháº¡m vi xá»­ lÃ½ cá»§a tá»«ng agent:\n"
            "1. `booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c **TÃŒM KIáº¾M, Lá»°A CHá»ŒN, Äáº¶T MUA** vÃ© mÃ¡y bay vÃ  "
            "cÃ¡c dá»‹ch vá»¥ Ä‘i kÃ¨m (hÃ nh lÃ½, suáº¥t Äƒn, chá»n chá»—) cho má»™t chuyá»ƒn bay cá»¥ thá»ƒ mÃ  khÃ¡ch hÃ ng Ä‘ang quan tÃ¢m hoáº·c muá»‘n Ä‘áº·t.\n"
            "2. `cancel_booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c há»§y bá» má»™t vÃ© Ä‘Ã£ Ä‘áº·t. "
            "YÃªu cáº§u nÃ y thÆ°á»ng bao gá»“m mÃ£ Ä‘áº·t chá»— hoáº·c thÃ´ng tin Ä‘á»§ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh booking cáº§n há»§y.\n"
            "3. `general_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u khÃ¡c náº±m ngoÃ i pháº¡m vi cá»§a cÃ¡c agent trÃªn.\n\n"

            "## Quy táº¯c phÃ¢n loáº¡i vÃ  chuyá»ƒn hÆ°á»›ng ##"
            "PhÃ¢n tÃ­ch **Ã½ Ä‘á»‹nh** cá»§a ngÆ°á»i dÃ¹ng má»™t cÃ¡ch cáº©n tháº­n vÃ  Ã¡p dá»¥ng quy táº¯c sau Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tÃ¡c tá»­ Ä‘Ã­ch:\n"
            "1. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **Há»¦Y** vÃ© -> chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `cancel_booking_agent`.\n"
            "2. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **TÃŒM, CHá»ŒN, Äáº¶T MUA**` má»™t chuyáº¿n bay hoáº·c dá»‹ch vá»¥ Ä‘i kÃ¨m -> "
            "chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `booking_agent`.\n"
            "3. Trong **Táº¤T Cáº¢ cÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i** (bao gá»“m há»i thÃ´ng tin chung, quy Ä‘á»‹nh, thá»§ tá»¥c, chÃ o há»i, "
            "cÃ¡c yÃªu cáº§u khÃ´ng rÃµ rÃ ng hoáº·c khÃ´ng liÃªn quan Ä‘áº¿n viá»‡c Ä‘áº·t/há»§y cá»¥ thá»ƒ) -> Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `general_agent`"

            "## LÆ°u Ã½ quan trá»ng ##\n"
            "Báº¡n **PHáº¢I LUÃ”N** pháº£n há»“i dÆ°á»›i dáº¡ng cáº¥u trÃºc `ManagerHandoff`"
        )"""),
            ("user", "YÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng: {input}"),
        ]
    )

    # Sá»­ dá»¥ng .with_structured_output Ä‘á»ƒ Ä‘áº£m báº£o LLM tráº£ vá» Ä‘Ãºng format
    structured_llm = llm.with_structured_output(ManagerHandoff)
    
    chain = prompt | structured_llm
    
    # Chá»‰ láº¥y tin nháº¯n cuá»‘i cÃ¹ng cá»§a ngÆ°á»i dÃ¹ng Ä‘á»ƒ phÃ¢n tÃ­ch
    user_input = state['messages'][-1].content
    result = chain.invoke({"input": user_input})
    
    return {"next_agent": result.target_agent_name}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\router.py`:

```````py
from ..graph.state import AgentState

SPECIALIST_AGENTS = ["booking_agent", "cancel_booking_agent", "general_agent"]

def proxy_router_node(state: AgentState) -> dict:
    """
    Node nÃ y hoáº¡t Ä‘á»™ng nhÆ° má»™t UserProxy. NÃ³ quyáº¿t Ä‘á»‹nh xem cÃ³ nÃªn
    gá»­i tháº³ng yÃªu cáº§u Ä‘áº¿n agent trÆ°á»›c Ä‘Ã³ hay khÃ´ng, hay pháº£i qua Manager.
    """

    previous_agent = state.get("previous_agent")
    
    if previous_agent and previous_agent in SPECIALIST_AGENTS:
        return {"next_agent": previous_agent}
    else:
        return {"next_agent": "manager"}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\utils.py`:

```````py
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from typing import List
from datetime import datetime, timedelta
import re

AIRPORT_MAP = {
    'hÃ  ná»™i': 'HAN', 'hanoi': 'HAN', 'ná»™i bÃ i': 'HAN',
    'há»“ chÃ­ minh': 'SGN', 'ho chi minh': 'SGN', 'hcm': 'SGN',
    'sÃ i gÃ²n': 'SGN', 'sai gon': 'SGN', 'tÃ¢n sÆ¡n nháº¥t': 'SGN',
    'Ä‘Ã  náºµng': 'DAD', 'da nang': 'DAD',
    # ThÃªm cÃ¡c sÃ¢n bay khÃ¡c...
}

def get_iata_code(location_name: str) -> str | None:
    if not location_name: return None
    normalized = location_name.lower().strip()
    
    # Náº¿u ngÆ°á»i dÃ¹ng nháº­p tháº³ng mÃ£ IATA (3 chá»¯ cÃ¡i)
    if len(normalized) == 3 and normalized.isalpha():
        return normalized.upper()
        
    return AIRPORT_MAP.get(normalized)

def convert_relative_date(date_str: str) -> str:
    """
    Chuyá»ƒn Ä‘á»•i cÃ¡c ngÃ y tÆ°Æ¡ng Ä‘á»‘i hoáº·c Ä‘á»‹nh dáº¡ng dd/mm sang Ä‘á»‹nh dáº¡ng 'YYYY-MM-DD'.

    Supported:
        - "hÃ´m nay"
        - "ngÃ y mai"
        - "ngÃ y má»‘t"
        - "dd/mm" hoáº·c "dd-mm"
        - "YYYY-mm-dd" (tráº£ vá» nguyÃªn báº£n náº¿u Ä‘Ãºng Ä‘á»‹nh dáº¡ng)
    """
    date_str = date_str.strip().lower()
    today = datetime.now()

    if date_str in ["hÃ´m nay", "hom nay"]:
        return today.strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y mai", "ngay mai"]:
        return (today + timedelta(days=1)).strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y má»‘t", "ngay mot"]:
        return (today + timedelta(days=2)).strftime("%Y-%m-%d")
    
    # Kiá»ƒm tra Ä‘á»‹nh dáº¡ng dd/mm hoáº·c dd-mm
    match = re.match(r"(\d{1,2})[/-](\d{1,2})", date_str)
    if match:
        day, month = map(int, match.groups())
        year = today.year
        try:
            dt = datetime(year, month, day)
            # Náº¿u ngÃ y Ä‘Ã£ qua trong nÄƒm hiá»‡n táº¡i, tá»± Ä‘á»™ng láº¥y nÄƒm sau
            if dt < today:
                dt = datetime(year + 1, month, day)
            return dt.strftime("%Y-%m-%d")
        except ValueError:
            raise ValueError(f"NgÃ y khÃ´ng há»£p lá»‡: {date_str}")

    # Kiá»ƒm tra xem cÃ³ pháº£i lÃ  ISO format YYYY-MM-DD khÃ´ng
    try:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        return dt.strftime("%Y-%m-%d")
    except ValueError:
        pass

    raise ValueError(f"KhÃ´ng thá»ƒ nháº­n dáº¡ng ngÃ y: {date_str}")

# Xá»­ lÃ­ tin nháº¯n há»™i thoáº¡i
def filter_for_human_ai(messages: List[BaseMessage]) -> List[BaseMessage]:
    """
    Lá»c lá»‹ch sá»­ há»™i thoáº¡i, chá»‰ giá»¯ láº¡i cÃ¡c tin nháº¯n tá»« ngÆ°á»i dÃ¹ng (HumanMessage)
    vÃ  cÃ¡c tin nháº¯n tráº£ lá»i cÃ³ ná»™i dung cá»§a AI (AIMessage).
    
    Loáº¡i bá»:
    - ToolMessage (káº¿t quáº£ tá»« tool)
    - AIMessage khÃ´ng cÃ³ ná»™i dung (thÆ°á»ng lÃ  cÃ¡c tin nháº¯n chá»©a tool_calls)
    """
    filtered_messages = []
    for m in messages:
        # Giá»¯ láº¡i táº¥t cáº£ HumanMessage
        if isinstance(m, HumanMessage):
            filtered_messages.append(m)
        # Chá»‰ giá»¯ láº¡i AIMessage náº¿u nÃ³ cÃ³ ná»™i dung vÄƒn báº£n Ä‘á»ƒ trÃ² chuyá»‡n
        elif isinstance(m, AIMessage) and m.content:
            filtered_messages.append(m)
    return filtered_messages
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\config.py`:

```````py
# src/flight_booking_agent/config.py
import os
from dotenv import load_dotenv
# Thay Ä‘á»•i import
from langchain_google_vertexai import ChatVertexAI



load_dotenv()
llm = ChatVertexAI(
    model_name="gemini-2.5-pro", 
    temperature=0.7,
    project="end-to-end-agentic-rag",  
    location="us-central1",     
)



```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\state.py`:

```````py
from typing import List, TypedDict, Annotated, Optional, Literal
from langchain_core.messages import BaseMessage
import operator

class AgentState(TypedDict):
    """
    Tráº¡ng thÃ¡i chung cho há»‡ thá»‘ng Multi-Agent, Ä‘Æ°á»£c chia sáº» qua táº¥t cáº£ cÃ¡c node.

    Attributes:
        messages: Lá»‹ch sá»­ há»™i thoáº¡i.
        next_agent: Agent tiáº¿p theo Ä‘Æ°á»£c gá»i, do Manager quyáº¿t Ä‘á»‹nh.
        ... cÃ¡c trÆ°á»ng dá»¯ liá»‡u khÃ¡c Ä‘Æ°á»£c thu tháº­p trong quÃ¡ trÃ¬nh ...
    """
    # Lá»‹ch sá»­ há»™i thoáº¡i
    messages: Annotated[List[BaseMessage], operator.add]

    # TrÆ°á»ng Ä‘iá»u hÆ°á»›ng luá»“ng
    next_agent: Optional[str]
    # LÆ°u láº¡i tÃªn cá»§a agent vá»«a hoáº¡t Ä‘á»™ng á»Ÿ lÆ°á»£t trÆ°á»›c.
    previous_agent: Optional[str]

    # CÃ¡c thÃ´ng tin Ä‘Æ°á»£c thu tháº­p (tÆ°Æ¡ng Ä‘Æ°Æ¡ng BookingDeps)
    airline: Optional[str]
    flight_number: Optional[str]
    departure_from: Optional[str]
    arrival_to: Optional[str]
    departure_date: Optional[str]
    departure_time: Optional[str]
    travel_class: Optional[Literal["ECONOMY", "PREMIUM_ECONOMY", "BUSINESS", "FIRST"]]
    passenger: Optional[List[dict]]
    ancillary: Optional[List[dict]]
    original_ticket_price: Optional[str]
    
    # Káº¿t quáº£ tÃ¬m kiáº¿m chuyáº¿n bay
    search_results: Optional[List[dict]]
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\workflow.py`:

```````py
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import ToolNode
from typing import Literal

from .state import AgentState
from ..agents import manager, booking, cancel_booking, general, router
from ..tools import booking_tools

# 1. Táº­p há»£p táº¥t cáº£ cÃ¡c tool (giá»¯ nguyÃªn)
all_tools = [
    booking_tools.search_flights_tool,
    #booking_tools.book_ticket,
    #booking_tools.get_payment_link,
    #booking_tools.cancel_booking,
    #general_tools.get_ancillary,
    #general_tools.general_retrieval,
]
tool_node = ToolNode(all_tools)

# 2. XÃ¢y dá»±ng Ä‘á»“ thá»‹
workflow = StateGraph(AgentState)

# ThÃªm táº¥t cáº£ cÃ¡c node
workflow.add_node("router", router.proxy_router_node)
workflow.add_node("manager", manager.manager_node)
workflow.add_node("booking_agent", booking.booking_node)
workflow.add_node("cancel_booking_agent", cancel_booking.cancel_booking_node)
workflow.add_node("general_agent", general.general_node)
workflow.add_node("tools", tool_node)

# 3. Äá»‹nh nghÄ©a cÃ¡c cáº¡nh

# Äiá»ƒm báº¯t Ä‘áº§u lÃ  router
workflow.set_entry_point("router")

# Cáº¡nh tá»« router (giá»¯ nguyÃªn)
workflow.add_conditional_edges(
    "router",
    lambda state: state["next_agent"],
    {
        "manager": "manager",
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
    }
)

# Cáº¡nh tá»« manager (giá»¯ nguyÃªn)
def route_from_manager(state: AgentState):
    next_agent = state.get("next_agent")
    return next_agent

# ThÃªm vÃ o workflow
workflow.add_conditional_edges("manager", route_from_manager)


# Cáº¡nh sau cÃ¡c agent chuyÃªn trÃ¡ch (giá»¯ nguyÃªn)
def route_after_task(state: AgentState):
    last_message = state['messages'][-1]
    if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
        return "tools"
    if state.get("next_agent") == "manager":
        return "manager"
    return END

workflow.add_conditional_edges("booking_agent", route_after_task)
workflow.add_conditional_edges("cancel_booking_agent", route_after_task)
workflow.add_conditional_edges("general_agent", route_after_task)


def route_after_tools(state: AgentState) -> str:
    previous_agent = state.get("previous_agent")
    if previous_agent:
        print(f">>> Tool execution finished. Returning to: {previous_agent}")
        return previous_agent
    else:
        # TrÆ°á»ng há»£p dá»± phÃ²ng, quay vá» manager
        return "manager"

workflow.add_conditional_edges(
    "tools",
    route_after_tools,
    {
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
        #"manager": "manager",
    }
)

# 4. BiÃªn dá»‹ch Ä‘á»“ thá»‹
app = workflow.compile()

try:
    app.get_graph().draw_mermaid_png(output_file_path="D:\Project\-n-T-t-Nghi-p-\img\workflow_graph.png")
    print("ÄÃ£ váº½ sÆ¡ Ä‘á»“ workflow ra file: workflow_graph.png")
except Exception as e:
    print(f"KhÃ´ng thá»ƒ váº½ Ä‘á»“ thá»‹ (cáº§n cÃ i Ä‘áº·t pygraphviz): {e}")
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\__init__.py`:

```````py
from .state import AgentState
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\output.txt`:

```````txt
Project Path: \\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent

Source Tree:

```
flight_booking_agent
â”œâ”€â”€ agents
â”‚   â”œâ”€â”€ booking.py
â”‚   â”œâ”€â”€ cancel_booking.py
â”‚   â”œâ”€â”€ general.py
â”‚   â”œâ”€â”€ manager.py
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ utils.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ booking.cpython-310.pyc
â”‚       â”œâ”€â”€ booking_manager.cpython-310.pyc
â”‚       â”œâ”€â”€ cancel_booking.cpython-310.pyc
â”‚       â”œâ”€â”€ flight_searcher.cpython-310.pyc
â”‚       â”œâ”€â”€ general.cpython-310.pyc
â”‚       â”œâ”€â”€ information_gatherer.cpython-310.pyc
â”‚       â”œâ”€â”€ manager.cpython-310.pyc
â”‚       â”œâ”€â”€ recommendation.cpython-310.pyc
â”‚       â”œâ”€â”€ router.cpython-310.pyc
â”‚       â”œâ”€â”€ utils.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ endpoints.py
â”‚   â”œâ”€â”€ schemas.py
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ config.py
â”œâ”€â”€ graph
â”‚   â”œâ”€â”€ state.py
â”‚   â”œâ”€â”€ workflow.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ state.cpython-310.pyc
â”‚       â”œâ”€â”€ workflow.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ amadeus_client.py
â”‚   â”œâ”€â”€ payment_client.py
â”‚   â”œâ”€â”€ skyscanner_client.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ amadeus_client.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ tools
â”‚   â”œâ”€â”€ booking_tools.py
â”‚   â”œâ”€â”€ cancel_tools.py
â”‚   â”œâ”€â”€ general_tools.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ __pycache__
â”‚       â”œâ”€â”€ booking_tools.cpython-310.pyc
â”‚       â”œâ”€â”€ flight_tools.cpython-310.pyc
â”‚       â”œâ”€â”€ general_tools.cpython-310.pyc
â”‚       â””â”€â”€ __init__.cpython-310.pyc
â”œâ”€â”€ __init__.py
â””â”€â”€ __pycache__
    â”œâ”€â”€ config.cpython-310.pyc
    â””â”€â”€ __init__.cpython-310.pyc

```

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\booking.py`:

```````py
import json
from datetime import datetime
from langchain_core.messages import SystemMessage, HumanMessage, ToolMessage, AIMessage
from pydantic import BaseModel, Field
from typing import Optional

from ..graph.state import AgentState
from ..config import llm
from ..tools.booking_tools import search_flights_tool
#from ..tools.booking_tools import book_ticket, get_payment_link
#from ..tools.general_tools import get_ancillary
from .utils import get_iata_code, convert_relative_date, filter_for_human_ai

# --- Pydantic model Ä‘á»ƒ trÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« há»™i thoáº¡i ---
class FlightInfoExtractor(BaseModel):
    """TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng."""
    departure_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘i")
    destination_city: Optional[str] = Field(None, description="ThÃ nh phá»‘ hoáº·c sÃ¢n bay Ä‘iá»ƒm Ä‘áº¿n")
    departure_date: Optional[str] = Field(None, description="NgÃ y Ä‘i, vÃ­ dá»¥: 'hÃ´m nay', 'ngÃ y mai', '25/12'")
    passenger_count: Optional[int] = Field(None, description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n")

# --- LLM vÃ  System Prompt ---
booking_llm = llm.bind_tools([
    search_flights_tool,
    #book_ticket,
    #get_payment_link,
    #get_ancillary,
])

SYSTEM_PROMPT = """Báº¡n lÃ  **Vivi**, má»™t trá»£ lÃ½ áº£o chuyÃªn há»— trá»£ nhá»¯ng váº¥n Ä‘á» liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ© mÃ¡y bay.

        ## HÆ°á»›ng dáº«n nghiá»‡p vá»¥ ##
        Nhiá»‡m vá»¥ cá»§a báº¡n lÃ  hÆ°á»›ng dáº«n khÃ¡ch hÃ ng Ä‘áº·t vÃ© theo quy trÃ¬nh CHáº¶T CHáº¼ tá»«ng bÆ°á»›c. TUYá»†T Äá»I KHÃ”NG Bá» QUA HOáº¶C NHáº¢Y CÃ“C CÃC BÆ¯á»šC.

        BÆ¯á»šC 1.  **TÃ¬m kiáº¿m chuyáº¿n bay:**
            * **Äáº§u tiÃªn:** Thu tháº­p Ä‘á»§ cÃ¡c thÃ´ng tin sau tá»« khÃ¡ch hÃ ng:
                * ThÃ nh phá»‘ khá»Ÿi hÃ nh
                * ThÃ nh phá»‘ Ä‘áº¿n
                * NgÃ y Ä‘i
                * Sá»‘ lÆ°á»£ng ngÆ°á»i lá»›n (+ tráº» em náº¿u cÃ³)
                * Háº¡ng vÃ©
            * **Khi Ä‘Ã£ cÃ³ Ä‘á»§ thÃ´ng tin trÃªn:** Sá»­ dá»¥ng tool `search_flights_tool`.
                * Náº¿u khÃ´ng tÃ¬m tháº¥y chuyáº¿n bay: Äá» xuáº¥t cÃ¡c giáº£i phÃ¡p khÃ¡c (Ä‘á»•i ngÃ y, sÃ¢n bay, háº¡ng vÃ©). Náº¿u váº«n khÃ´ng tÃ¬m tháº¥y: BÃ¡o khÃ¡ch hÃ ng khÃ´ng cÃ³ chuyáº¿n bay phÃ¹ há»£p.
                * Náº¿u tÃ¬m tháº¥y chuyáº¿n bay: Hiá»ƒn thá»‹ **TÃ“M Táº®T** danh sÃ¡ch chuyáº¿n bay (Giá» bay, HÃ£ng bay, GiÃ¡).
            * **Sau khi khÃ¡ch hÃ ng chá»n 1 chuyáº¿n bay tá»« danh sÃ¡ch tÃ³m táº¯t:** Hiá»ƒn thá»‹ **Äáº¦Y Äá»¦** thÃ´ng tin chi tiáº¿t cá»§a chuyáº¿n bay Ä‘Ã³ vÃ  **Báº®T BUá»˜C** yÃªu cáº§u khÃ¡ch hÃ ng xÃ¡c nháº­n láº§n cuá»‘i trÆ°á»›c khi chuyá»ƒn sang bÆ°á»›c tiáº¿p theo.

        BÆ¯á»šC 2.  **ThÃ´ng tin hÃ nh khÃ¡ch & Dá»‹ch vá»¥ bá»• sung:**
            * **Sau khi khÃ¡ch hÃ ng xÃ¡c nháº­n chuyáº¿n bay:** Thu tháº­p thÃ´ng tin **Báº®T BUá»˜C** cho Táº¤T Cáº¢ hÃ nh khÃ¡ch:
                * Há» vÃ  tÃªn Ä‘áº§y Ä‘á»§
                * NgÃ y thÃ¡ng nÄƒm sinh
                * Sá»‘ Ä‘iá»‡n thoáº¡i
                *(ThÃ´ng tin tÃ¹y chá»n: Giá»›i tÃ­nh, Email)*
            * **Sau khi Ä‘Ã£ thu tháº­p Ä‘á»§ thÃ´ng tin hÃ nh khÃ¡ch cho táº¥t cáº£ má»i ngÆ°á»i:** Há»i khÃ¡ch hÃ ng cÃ³ muá»‘n mua thÃªm dá»‹ch vá»¥ bá»• sung khÃ´ng.
                * Náº¿u khÃ¡ch hÃ ng quan tÃ¢m: DÃ¹ng tool `get_ancillary` Ä‘á»ƒ tra cá»©u vÃ  tÆ° váº¥n cÃ¡c dá»‹ch vá»¥ kháº£ dá»¥ng kÃ¨m giÃ¡. 
                * Thu tháº­p lá»±a chá»n dá»‹ch vá»¥ cá»§a khÃ¡ch hÃ ng.

        BÆ¯á»šC 3.  **Thanh toÃ¡n & HoÃ n táº¥t Ä‘áº·t vÃ©:**
            * **NGAY TRÆ¯á»šC KHI yÃªu cáº§u thanh toÃ¡n:** **Báº®T BUá»˜C** hiá»ƒn thá»‹ láº¡i **TOÃ€N Bá»˜** thÃ´ng tin Ä‘áº·t vÃ© vÃ  yÃªu cáº§u khÃ¡ch hÃ ng kiá»ƒm tra láº¡i tháº­t ká»¹.
            * **YÃªu cáº§u khÃ¡ch hÃ ng pháº£n há»“i há»£p lá»‡:** Náº¿u thÃ´ng tin Ä‘áº·t vÃ© lÃ  Ä‘Ãºng, yÃªu cáº§u khÃ¡ch hÃ ng pháº£n há»“i lÃ  `xÃ¡c nháº­n` Ä‘á»ƒ tiáº¿p tá»¥c.
            * **CHá»ˆ KHI** khÃ¡ch hÃ ng `xÃ¡c nháº­n` thÃ´ng tin Ä‘Ãºng: sá»­ dá»¥ng tool `get_payment_link` vÃ  yÃªu cáº§u khÃ¡ch hÃ ng pháº£n há»“i `Ä‘Ã£ thanh toÃ¡n` Ä‘á»ƒ nháº­n mÃ£ Ä‘áº·t chá»—.
            * **CHá»ˆ KHI** khÃ¡c hÃ ng `Ä‘Ã£ thanh toÃ¡n` xong qua link trÃªn: Sá»­ dá»¥ng tool `book_ticket` Ä‘á»ƒ hoÃ n táº¥t Ä‘áº·t vÃ© vÃ  cung cáº¥p mÃ£ Ä‘áº·t chá»— cho khÃ¡ch hÃ ng.

        ## Chuyá»ƒn hÆ°á»›ng ##
        Thá»±c hiá»‡n chuyá»ƒn hÆ°á»›ng tá»›i `manager_agent`, **TUYá»†T Äá»I** khÃ´ng tá»± Ã½ tráº£ lá»i náº¿u yÃªu cáº§u cá»§a khÃ¡ch hÃ ng khÃ´ng liÃªn quan Ä‘áº¿n tÃ¬m kiáº¿m chuyáº¿n bay, Ä‘áº·t vÃ©.\
        Khi quyáº¿t Ä‘á»‹nh chuyá»ƒn há»©ng, hÃ£y tráº£ vá» dáº¡ng cáº¥u trÃºc `BookingHandoff`.

        ## Giao tiáº¿p ##
        - Gá»i khÃ¡ch lÃ  **anh/chá»‹**. XÆ°ng **em** vá»›i báº£n thÃ¢n.
        - TrÃ¡nh dÃ¹ng 'tÃ´i', 'mÃ¬nh' hay gá»i khÃ¡ch lÃ  'em'.
        - VÄƒn phong tá»± nhiÃªn, thÃ¢n thiá»‡n nhÆ° ngÆ°á»i tháº­t.
        - NÃ³i chuyá»‡n ngáº¯n gá»n, rÃµ Ã½. TrÃ¡nh dÃ i dÃ²ng, ráº­p khuÃ´n.

        ## QUAN TRá»ŒNG ##
         - Khi nháº­n Ä‘Æ°á»£c káº¿t quáº£ tá»« tool (ToolMessage), hÃ£y tÃ³m táº¯t nÃ³ cho ngÆ°á»i dÃ¹ng vÃ  Ä‘á» xuáº¥t bÆ°á»›c tiáº¿p theo.
         - Náº¿u yÃªu cáº§u cá»§a khÃ¡ch hÃ ng khÃ´ng liÃªn quan Ä‘áº¿n Ä‘áº·t vÃ©, hÃ£y nÃ³i chÃ­nh xÃ¡c cÃ¢u: "Vá» váº¥n Ä‘á» nÃ y, em xin phÃ©p chuyá»ƒn cho má»™t chuyÃªn viÃªn khÃ¡c." vÃ  khÃ´ng lÃ m gÃ¬ thÃªm.
        - LuÃ´n giao tiáº¿p thÃ¢n thiá»‡n, gá»i khÃ¡ch lÃ  anh/chá»‹ vÃ  xÆ°ng em.
"""

# Má»i thá»© import vÃ  Ä‘á»‹nh nghÄ©a bÃªn trÃªn giá»¯ nguyÃªn

def booking_node(state: AgentState) -> dict:
    """
    Node xá»­ lÃ½ toÃ n bá»™ nghiá»‡p vá»¥ Ä‘áº·t vÃ© mÃ¡y bay má»™t cÃ¡ch tuáº§n tá»±.
    (PhiÃªn báº£n Ä‘Ã£ tÃ¡i cáº¥u trÃºc theo state)
    """
    print("---NODE: BOOKING---")
    messages = filter_for_human_ai(state["messages"])
    current_agent = "booking_agent" # Äá»‹nh nghÄ©a sáºµn Ä‘á»ƒ dÃ¹ng chung

    # ThÃªm system prompt náº¿u chÆ°a cÃ³
    if not any(isinstance(m, SystemMessage) and m.content == SYSTEM_PROMPT for m in messages):
        messages.insert(0, SystemMessage(content=SYSTEM_PROMPT))

    # ==============================================================================
    # LOGIC Má»šI: KIá»‚M TRA TRáº NG THÃI Tá»ª CAO XUá»NG THáº¤P
    # ==============================================================================

    # STATE 1: Xá»­ lÃ½ káº¿t quáº£ vá»«a nháº­n Ä‘Æ°á»£c tá»« Tool
    if isinstance(messages[-1], ToolMessage):
        print(">>> Booking Node [State 1]: Äang xá»­ lÃ½ káº¿t quáº£ tá»« Tool...")
        try:
            search_results_data = json.loads(messages[-1].content)
        except json.JSONDecodeError:
            search_results_data = {"error": "Dá»¯ liá»‡u tráº£ vá» tá»« tool khÃ´ng há»£p lá»‡."}

        prompt = HumanMessage(
            content=f"""Dá»±a vÃ o káº¿t quáº£ tá»« tool call sau Ä‘Ã¢y:
            ---
            {messages[-1].content}
            ---
            HÃ£y tÃ³m táº¯t káº¿t quáº£ cho ngÆ°á»i dÃ¹ng vÃ  há»i há» muá»‘n chá»n chuyáº¿n bay nÃ o.
            """
        )
        response = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), prompt])
        
        return {
            "messages": [response],
            "search_results": search_results_data
            ,"previous_agent": current_agent
        }

    # STATE 2: ÄÃ£ cÃ³ káº¿t quáº£ tÃ¬m kiáº¿m, bÃ¢y giá» xá»­ lÃ½ lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng
    # ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t Ä‘á»ƒ ngáº¯t vÃ²ng láº·p.
    # Náº¿u Ä‘Ã£ cÃ³ `search_results`, chÃºng ta pháº£i xá»­ lÃ½ lá»±a chá»n chá»© khÃ´ng pháº£i tÃ¬m kiáº¿m láº¡i.
    if state.get("search_results"):
        print(">>> Booking Node [State 2]: ÄÃ£ cÃ³ káº¿t quáº£, xá»­ lÃ½ lá»±a chá»n cá»§a ngÆ°á»i dÃ¹ng...")
        
        filtered_messages = filter_for_human_ai(messages)
        
        contextual_prompt = HumanMessage(
            content=f"""
            Ngá»¯ cáº£nh: Em vá»«a gá»­i cho khÃ¡ch danh sÃ¡ch cÃ¡c chuyáº¿n bay sau:
            {json.dumps(state.get("search_results"), ensure_ascii=False, indent=2)}

            BÃ¢y giá», khÃ¡ch hÃ ng tráº£ lá»i: "{messages[-1].content}"

            Dá»±a vÃ o cÃ¢u tráº£ lá»i cá»§a khÃ¡ch, hÃ£y thá»±c hiá»‡n bÆ°á»›c tiáº¿p theo trong quy trÃ¬nh.
            - Náº¿u khÃ¡ch CHá»ŒN má»™t chuyáº¿n bay: HÃ£y hiá»ƒn thá»‹ thÃ´ng tin CHI TIáº¾T cá»§a chuyáº¿n Ä‘Ã³ vÃ  YÃŠU Cáº¦U XÃC NHáº¬N.
            - Náº¿u khÃ¡ch há»i thÃªm hoáº·c muá»‘n tÃ¬m láº¡i: HÃ£y tráº£ lá»i vÃ  xá»­ lÃ½ yÃªu cáº§u Ä‘Ã³.
            - Náº¿u yÃªu cáº§u cá»§a khÃ¡ch khÃ´ng liÃªn quan: Chuyá»ƒn hÆ°á»›ng cho chuyÃªn viÃªn khÃ¡c.
            """
        )
        
        final_prompt = [SystemMessage(content=SYSTEM_PROMPT)] + filtered_messages[:-1] + [contextual_prompt]
        response = booking_llm.invoke(final_prompt)

        if "chuyÃªn viÃªn khÃ¡c" in response.content:
            return {
                "messages": [response],
                "next_agent": "manager",
                "previous_agent": current_agent
            }

        return {
            "messages": [response],
            "previous_agent": current_agent
        }

    # STATE 3: Thu tháº­p thÃ´ng tin vÃ  kÃ­ch hoáº¡t tÃ¬m kiáº¿m (chá»‰ cháº¡y khi chÆ°a cÃ³ search_results)
    print(">>> Booking Node [State 3]: Thu tháº­p thÃ´ng tin...")
    structured_llm = llm.with_structured_output(FlightInfoExtractor)
    extractor_prompt = f"TrÃ­ch xuáº¥t thÃ´ng tin chuyáº¿n bay tá»« cÃ¢u sau. Input: \"{messages[-1].content}\""
    extracted_info = structured_llm.invoke(extractor_prompt)

    current_info = {
        "departure_from": state.get("departure_from"),
        "arrival_to": state.get("arrival_to"),
        "departure_date": state.get("departure_date"),
        "passenger_count": state.get("passenger_count"),
    }

    if extracted_info.departure_city: current_info["departure_from"] = get_iata_code(extracted_info.departure_city)
    if extracted_info.destination_city: current_info["arrival_to"] = get_iata_code(extracted_info.destination_city)
    if extracted_info.departure_date: current_info["departure_date"] = convert_relative_date(extracted_info.departure_date)
    if extracted_info.passenger_count: current_info["passenger_count"] = extracted_info.passenger_count

    # Náº¿u Ä‘Ã£ Ä‘á»§ thÃ´ng tin, gá»i tool
    if all(current_info.values()):
        print(">>> Booking Node: Äá»§ thÃ´ng tin, chuáº©n bá»‹ gá»i Tool tÃ¬m kiáº¿m...")
        tool_input_message = HumanMessage(
            content=f"TÃ¬m chuyáº¿n bay tá»« {current_info['departure_from']} Ä‘áº¿n {current_info['arrival_to']} vÃ o ngÃ y {current_info['departure_date']} vÃ  cho {current_info['passenger_count']} hÃ nh khÃ¡ch."
        )
        response_with_tool_call = booking_llm.invoke([SystemMessage(content=SYSTEM_PROMPT), tool_input_message])
        
        return {
            **current_info,
            "messages": [response_with_tool_call],
            "previous_agent": current_agent
        }
    
    # Náº¿u chÆ°a Ä‘á»§ thÃ´ng tin, há»i ngÆ°á»i dÃ¹ng
    required_info_map = {
        "Ä‘iá»ƒm Ä‘i": "departure_from", "Ä‘iá»ƒm Ä‘áº¿n": "arrival_to",
        "ngÃ y Ä‘i": "departure_date", "sá»‘ lÆ°á»£ng vÃ©": "passenger_count"
    }
    missing_info = [name for name, key in required_info_map.items() if not current_info.get(key)]

    if missing_info:
        print(f">>> Booking Node: Thiáº¿u thÃ´ng tin: {missing_info}")
        ask_prompt = f"Dáº¡, Ä‘á»ƒ tÃ¬m chuyáº¿n bay, anh/chá»‹ vui lÃ²ng cho em biáº¿t thÃªm vá» {', '.join(missing_info)} áº¡."
        response = AIMessage(content=ask_prompt)
        return {**current_info, "messages": [response], "previous_agent": current_agent}

    # TrÆ°á»ng há»£p dá»± phÃ²ng: Náº¿u khÃ´ng rÆ¡i vÃ o cÃ¡c state trÃªn, tráº£ lá»i chung chung
    print(">>> Booking Node [Fallback]: Xá»­ lÃ½ yÃªu cáº§u chung...")
    response = booking_llm.invoke(filter_for_human_ai(messages))
    return {"messages": [response], "previous_agent": current_agent}
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    # --- GIAI ÄOáº N 3: Xá»­ lÃ½ cÃ¡c yÃªu cáº§u khÃ¡c vÃ  chuyá»ƒn hÆ°á»›ng ---
    filtered_messages = filter_for_human_ai(messages)
    
    # Sá»­ dá»¥ng `filtered_messages` Ä‘á»ƒ LLM cÃ³ ngá»¯ cáº£nh sáº¡ch hÆ¡n
    response = booking_llm.invoke(filtered_messages)
    current_agent = "booking_agent"

    if "chuyÃªn viÃªn khÃ¡c" in response.content:
        return {
            "messages": [response],
            "next_agent": "manager",
            "previous_agent": current_agent
        }

    return {
        "messages": [response],
        "previous_agent": current_agent
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\cancel_booking.py`:

```````py
# src/flight_booking_agent/agents/cancel_booking.py
from langchain_core.messages import AIMessage
from ..graph.state import AgentState

# Giáº£ láº­p cÃ¡c tool cÃ³ thá»ƒ cáº§n
# from ..tools.booking_tools import cancel_booking

# Giáº£ láº­p llm
# from ..config import llm

def cancel_booking_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ nghiá»‡p vá»¥ há»§y vÃ©.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i tool há»§y vÃ©.
    """
    print("---NODE: CANCEL BOOKING (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o
    response_message = AIMessage(content="Dáº¡, Ä‘á»ƒ há»§y vÃ©, anh/chá»‹ vui lÃ²ng cung cáº¥p mÃ£ Ä‘áº·t chá»— áº¡.")
    
    return {
        "messages": [response_message],
        "previous_agent": "cancel_booking_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\general.py`:

```````py
# src/flight_booking_agent/agents/information_gatherer.py
import json
from datetime import datetime, timedelta
from typing import Optional
# Sá»¬A Lá»–I PYDANTIC: Import trá»±c tiáº¿p tá»« pydantic
from pydantic import BaseModel, Field
from langchain_core.messages import SystemMessage, AIMessage, HumanMessage

from ..config import llm
from ..graph.state import AgentState

from .utils import get_iata_code, convert_relative_date


# === THÃŠM HÃ€M Má»šI Táº I ÄÃ‚Y ===
def general_node(state: AgentState) -> dict:
    """
    NODE GIáº¢ Láº¬P: Xá»­ lÃ½ cÃ¡c cÃ¢u há»i chung.
    Trong tÆ°Æ¡ng lai, node nÃ y sáº½ chá»©a logic Ä‘á»ƒ gá»i RAG hoáº·c cÃ¡c tool kiáº¿n thá»©c chung.
    """
    print("---NODE: GENERAL (Placeholder)---")
    
    # Hiá»‡n táº¡i, chá»‰ tráº£ vá» má»™t tin nháº¯n thÃ´ng bÃ¡o chung
    response_message = AIMessage(content="Dáº¡, em cÃ³ thá»ƒ giÃºp gÃ¬ khÃ¡c cho anh/chá»‹ áº¡?")
    
    return {
        "messages": [response_message],
        "previous_agent": "general_agent"
    }
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\manager.py`:

```````py
from langchain_core.prompts import ChatPromptTemplate
from pydantic import BaseModel, Field
from typing import Literal
from ..graph.state import AgentState
from ..config import llm

# Pydantic model Ä‘á»ƒ Ä‘á»‹nh nghÄ©a output cÃ³ cáº¥u trÃºc cho Manager
class ManagerHandoff(BaseModel):
    target_agent_name: Literal["booking_agent", "general_agent", "cancel_booking_agent", "END"] = Field(
        ..., description="Agent chuyÃªn trÃ¡ch phÃ¹ há»£p Ä‘á»ƒ xá»­ lÃ½ yÃªu cáº§u."
    )

def manager_node(state: AgentState) -> dict:
    """
    Node Ä‘iá»u phá»‘i: PhÃ¢n tÃ­ch yÃªu cáº§u vÃ  quyáº¿t Ä‘á»‹nh agent tiáº¿p theo.
    """
    
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system",
             """"## Vai trÃ² ##"
            "Báº¡n lÃ  **Vivi**, lÃ  má»™t trá»£ lÃ½ áº£o Ä‘Ã³ng vai trÃ² Ä‘iá»u phá»‘i viÃªn, "
            "Nhiá»‡m vá»¥ **DUY NHáº¤T** cá»§a báº¡n lÃ  phÃ¢n tÃ­ch yÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng vÃ  "
            "**chuyá»ƒn hÆ°á»›ng chÃ­nh xÃ¡c** Ä‘áº¿n agent chuyÃªn trÃ¡ch phÃ¹ há»£p. "
            "Báº¡n **TUYá»†T Äá»I KHÃ”NG** Ä‘Æ°á»£c tá»± mÃ¬nh tráº£ lá»i báº¥t ká»³ cÃ¢u há»i nÃ o cá»§a khÃ¡ch hÃ ng.\n\n"

            "## CÃ¡c agent chuyÃªn trÃ¡ch & pháº¡m vi xá»­ lÃ½ ##\n"
            "Äá»ƒ phÃ¢n loáº¡i chÃ­nh xÃ¡c, hÃ£y náº¯m rÃµ pháº¡m vi xá»­ lÃ½ cá»§a tá»«ng agent:\n"
            "1. `booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c **TÃŒM KIáº¾M, Lá»°A CHá»ŒN, Äáº¶T MUA** vÃ© mÃ¡y bay vÃ  "
            "cÃ¡c dá»‹ch vá»¥ Ä‘i kÃ¨m (hÃ nh lÃ½, suáº¥t Äƒn, chá»n chá»—) cho má»™t chuyá»ƒn bay cá»¥ thá»ƒ mÃ  khÃ¡ch hÃ ng Ä‘ang quan tÃ¢m hoáº·c muá»‘n Ä‘áº·t.\n"
            "2. `cancel_booking_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u **LIÃŠN QUAN TRá»°C TIáº¾P** Ä‘áº¿n viá»‡c há»§y bá» má»™t vÃ© Ä‘Ã£ Ä‘áº·t. "
            "YÃªu cáº§u nÃ y thÆ°á»ng bao gá»“m mÃ£ Ä‘áº·t chá»— hoáº·c thÃ´ng tin Ä‘á»§ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh booking cáº§n há»§y.\n"
            "3. `general_agent`: xá»­ lÃ½ cÃ¡c yÃªu cáº§u khÃ¡c náº±m ngoÃ i pháº¡m vi cá»§a cÃ¡c agent trÃªn.\n\n"

            "## Quy táº¯c phÃ¢n loáº¡i vÃ  chuyá»ƒn hÆ°á»›ng ##"
            "PhÃ¢n tÃ­ch **Ã½ Ä‘á»‹nh** cá»§a ngÆ°á»i dÃ¹ng má»™t cÃ¡ch cáº©n tháº­n vÃ  Ã¡p dá»¥ng quy táº¯c sau Ä‘á»ƒ xÃ¡c Ä‘á»‹nh tÃ¡c tá»­ Ä‘Ã­ch:\n"
            "1. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **Há»¦Y** vÃ© -> chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `cancel_booking_agent`.\n"
            "2. Náº¿u yÃªu cáº§u rÃµ rÃ ng lÃ  muá»‘n **TÃŒM, CHá»ŒN, Äáº¶T MUA**` má»™t chuyáº¿n bay hoáº·c dá»‹ch vá»¥ Ä‘i kÃ¨m -> "
            "chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `booking_agent`.\n"
            "3. Trong **Táº¤T Cáº¢ cÃ¡c trÆ°á»ng há»£p cÃ²n láº¡i** (bao gá»“m há»i thÃ´ng tin chung, quy Ä‘á»‹nh, thá»§ tá»¥c, chÃ o há»i, "
            "cÃ¡c yÃªu cáº§u khÃ´ng rÃµ rÃ ng hoáº·c khÃ´ng liÃªn quan Ä‘áº¿n viá»‡c Ä‘áº·t/há»§y cá»¥ thá»ƒ) -> Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `general_agent`"

            "## LÆ°u Ã½ quan trá»ng ##\n"
            "Báº¡n **PHáº¢I LUÃ”N** pháº£n há»“i dÆ°á»›i dáº¡ng cáº¥u trÃºc `ManagerHandoff`"
        )"""),
            ("user", "YÃªu cáº§u cá»§a ngÆ°á»i dÃ¹ng: {input}"),
        ]
    )

    # Sá»­ dá»¥ng .with_structured_output Ä‘á»ƒ Ä‘áº£m báº£o LLM tráº£ vá» Ä‘Ãºng format
    structured_llm = llm.with_structured_output(ManagerHandoff)
    
    chain = prompt | structured_llm
    
    # Chá»‰ láº¥y tin nháº¯n cuá»‘i cÃ¹ng cá»§a ngÆ°á»i dÃ¹ng Ä‘á»ƒ phÃ¢n tÃ­ch
    user_input = state['messages'][-1].content
    result = chain.invoke({"input": user_input})
    
    return {"next_agent": result.target_agent_name}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\router.py`:

```````py
from ..graph.state import AgentState

SPECIALIST_AGENTS = ["booking_agent", "cancel_booking_agent", "general_agent"]

def proxy_router_node(state: AgentState) -> dict:
    """
    Node nÃ y hoáº¡t Ä‘á»™ng nhÆ° má»™t UserProxy. NÃ³ quyáº¿t Ä‘á»‹nh xem cÃ³ nÃªn
    gá»­i tháº³ng yÃªu cáº§u Ä‘áº¿n agent trÆ°á»›c Ä‘Ã³ hay khÃ´ng, hay pháº£i qua Manager.
    """

    previous_agent = state.get("previous_agent")
    
    if previous_agent and previous_agent in SPECIALIST_AGENTS:
        return {"next_agent": previous_agent}
    else:
        return {"next_agent": "manager"}
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\agents\utils.py`:

```````py
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from typing import List
from datetime import datetime, timedelta
import re

AIRPORT_MAP = {
    'hÃ  ná»™i': 'HAN', 'hanoi': 'HAN', 'ná»™i bÃ i': 'HAN',
    'há»“ chÃ­ minh': 'SGN', 'ho chi minh': 'SGN', 'hcm': 'SGN',
    'sÃ i gÃ²n': 'SGN', 'sai gon': 'SGN', 'tÃ¢n sÆ¡n nháº¥t': 'SGN',
    'Ä‘Ã  náºµng': 'DAD', 'da nang': 'DAD',
    # ThÃªm cÃ¡c sÃ¢n bay khÃ¡c...
}

def get_iata_code(location_name: str) -> str | None:
    if not location_name: return None
    normalized = location_name.lower().strip()
    
    # Náº¿u ngÆ°á»i dÃ¹ng nháº­p tháº³ng mÃ£ IATA (3 chá»¯ cÃ¡i)
    if len(normalized) == 3 and normalized.isalpha():
        return normalized.upper()
        
    return AIRPORT_MAP.get(normalized)

def convert_relative_date(date_str: str) -> str:
    """
    Chuyá»ƒn Ä‘á»•i cÃ¡c ngÃ y tÆ°Æ¡ng Ä‘á»‘i hoáº·c Ä‘á»‹nh dáº¡ng dd/mm sang Ä‘á»‹nh dáº¡ng 'YYYY-MM-DD'.

    Supported:
        - "hÃ´m nay"
        - "ngÃ y mai"
        - "ngÃ y má»‘t"
        - "dd/mm" hoáº·c "dd-mm"
        - "YYYY-mm-dd" (tráº£ vá» nguyÃªn báº£n náº¿u Ä‘Ãºng Ä‘á»‹nh dáº¡ng)
    """
    date_str = date_str.strip().lower()
    today = datetime.now()

    if date_str in ["hÃ´m nay", "hom nay"]:
        return today.strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y mai", "ngay mai"]:
        return (today + timedelta(days=1)).strftime("%Y-%m-%d")
    elif date_str in ["ngÃ y má»‘t", "ngay mot"]:
        return (today + timedelta(days=2)).strftime("%Y-%m-%d")
    
    # Kiá»ƒm tra Ä‘á»‹nh dáº¡ng dd/mm hoáº·c dd-mm
    match = re.match(r"(\d{1,2})[/-](\d{1,2})", date_str)
    if match:
        day, month = map(int, match.groups())
        year = today.year
        try:
            dt = datetime(year, month, day)
            # Náº¿u ngÃ y Ä‘Ã£ qua trong nÄƒm hiá»‡n táº¡i, tá»± Ä‘á»™ng láº¥y nÄƒm sau
            if dt < today:
                dt = datetime(year + 1, month, day)
            return dt.strftime("%Y-%m-%d")
        except ValueError:
            raise ValueError(f"NgÃ y khÃ´ng há»£p lá»‡: {date_str}")

    # Kiá»ƒm tra xem cÃ³ pháº£i lÃ  ISO format YYYY-MM-DD khÃ´ng
    try:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        return dt.strftime("%Y-%m-%d")
    except ValueError:
        pass

    raise ValueError(f"KhÃ´ng thá»ƒ nháº­n dáº¡ng ngÃ y: {date_str}")

# Xá»­ lÃ­ tin nháº¯n há»™i thoáº¡i
def filter_for_human_ai(messages: List[BaseMessage]) -> List[BaseMessage]:
    """
    Lá»c lá»‹ch sá»­ há»™i thoáº¡i, chá»‰ giá»¯ láº¡i cÃ¡c tin nháº¯n tá»« ngÆ°á»i dÃ¹ng (HumanMessage)
    vÃ  cÃ¡c tin nháº¯n tráº£ lá»i cÃ³ ná»™i dung cá»§a AI (AIMessage).
    
    Loáº¡i bá»:
    - ToolMessage (káº¿t quáº£ tá»« tool)
    - AIMessage khÃ´ng cÃ³ ná»™i dung (thÆ°á»ng lÃ  cÃ¡c tin nháº¯n chá»©a tool_calls)
    """
    filtered_messages = []
    for m in messages:
        # Giá»¯ láº¡i táº¥t cáº£ HumanMessage
        if isinstance(m, HumanMessage):
            filtered_messages.append(m)
        # Chá»‰ giá»¯ láº¡i AIMessage náº¿u nÃ³ cÃ³ ná»™i dung vÄƒn báº£n Ä‘á»ƒ trÃ² chuyá»‡n
        elif isinstance(m, AIMessage) and m.content:
            filtered_messages.append(m)
    return filtered_messages
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\config.py`:

```````py
# src/flight_booking_agent/config.py
import os
from dotenv import load_dotenv
# Thay Ä‘á»•i import
from langchain_google_vertexai import ChatVertexAI



load_dotenv()
llm = ChatVertexAI(
    model_name="gemini-2.5-pro", 
    temperature=0.7,
    project="end-to-end-agentic-rag",  
    location="us-central1",     
)



```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\state.py`:

```````py
from typing import List, TypedDict, Annotated, Optional, Literal
from langchain_core.messages import BaseMessage
import operator

class AgentState(TypedDict):
    """
    Tráº¡ng thÃ¡i chung cho há»‡ thá»‘ng Multi-Agent, Ä‘Æ°á»£c chia sáº» qua táº¥t cáº£ cÃ¡c node.

    Attributes:
        messages: Lá»‹ch sá»­ há»™i thoáº¡i.
        next_agent: Agent tiáº¿p theo Ä‘Æ°á»£c gá»i, do Manager quyáº¿t Ä‘á»‹nh.
        ... cÃ¡c trÆ°á»ng dá»¯ liá»‡u khÃ¡c Ä‘Æ°á»£c thu tháº­p trong quÃ¡ trÃ¬nh ...
    """
    # Lá»‹ch sá»­ há»™i thoáº¡i
    messages: Annotated[List[BaseMessage], operator.add]

    # TrÆ°á»ng Ä‘iá»u hÆ°á»›ng luá»“ng
    next_agent: Optional[str]
    # LÆ°u láº¡i tÃªn cá»§a agent vá»«a hoáº¡t Ä‘á»™ng á»Ÿ lÆ°á»£t trÆ°á»›c.
    previous_agent: Optional[str]

    # CÃ¡c thÃ´ng tin Ä‘Æ°á»£c thu tháº­p (tÆ°Æ¡ng Ä‘Æ°Æ¡ng BookingDeps)
    airline: Optional[str]
    flight_number: Optional[str]
    departure_from: Optional[str]
    arrival_to: Optional[str]
    departure_date: Optional[str]
    departure_time: Optional[str]
    travel_class: Optional[Literal["ECONOMY", "PREMIUM_ECONOMY", "BUSINESS", "FIRST"]]
    passenger: Optional[List[dict]]
    ancillary: Optional[List[dict]]
    original_ticket_price: Optional[str]
    
    # Káº¿t quáº£ tÃ¬m kiáº¿m chuyáº¿n bay
    search_results: Optional[List[dict]]
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\workflow.py`:

```````py
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import ToolNode
from typing import Literal

from .state import AgentState
from ..agents import manager, booking, cancel_booking, general, router
from ..tools import booking_tools

# 1. Táº­p há»£p táº¥t cáº£ cÃ¡c tool (giá»¯ nguyÃªn)
all_tools = [
    booking_tools.search_flights_tool,
    #booking_tools.book_ticket,
    #booking_tools.get_payment_link,
    #booking_tools.cancel_booking,
    #general_tools.get_ancillary,
    #general_tools.general_retrieval,
]
tool_node = ToolNode(all_tools)

# 2. XÃ¢y dá»±ng Ä‘á»“ thá»‹
workflow = StateGraph(AgentState)

# ThÃªm táº¥t cáº£ cÃ¡c node
workflow.add_node("router", router.proxy_router_node)
workflow.add_node("manager", manager.manager_node)
workflow.add_node("booking_agent", booking.booking_node)
workflow.add_node("cancel_booking_agent", cancel_booking.cancel_booking_node)
workflow.add_node("general_agent", general.general_node)
workflow.add_node("tools", tool_node)

# 3. Äá»‹nh nghÄ©a cÃ¡c cáº¡nh

# Äiá»ƒm báº¯t Ä‘áº§u lÃ  router
workflow.set_entry_point("router")

# Cáº¡nh tá»« router (giá»¯ nguyÃªn)
workflow.add_conditional_edges(
    "router",
    lambda state: state["next_agent"],
    {
        "manager": "manager",
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
    }
)

# Cáº¡nh tá»« manager (giá»¯ nguyÃªn)
def route_from_manager(state: AgentState):
    next_agent = state.get("next_agent")
    return next_agent

# ThÃªm vÃ o workflow
workflow.add_conditional_edges("manager", route_from_manager)


# Cáº¡nh sau cÃ¡c agent chuyÃªn trÃ¡ch (giá»¯ nguyÃªn)
def route_after_task(state: AgentState):
    last_message = state['messages'][-1]
    if hasattr(last_message, 'tool_calls') and last_message.tool_calls:
        return "tools"
    if state.get("next_agent") == "manager":
        return "manager"
    return END

workflow.add_conditional_edges("booking_agent", route_after_task)
workflow.add_conditional_edges("cancel_booking_agent", route_after_task)
workflow.add_conditional_edges("general_agent", route_after_task)


def route_after_tools(state: AgentState) -> str:
    previous_agent = state.get("previous_agent")
    if previous_agent:
        print(f">>> Tool execution finished. Returning to: {previous_agent}")
        return previous_agent
    else:
        # TrÆ°á»ng há»£p dá»± phÃ²ng, quay vá» manager
        return "manager"

workflow.add_conditional_edges(
    "tools",
    route_after_tools,
    {
        "booking_agent": "booking_agent",
        "cancel_booking_agent": "cancel_booking_agent",
        "general_agent": "general_agent",
        #"manager": "manager",
    }
)

# 4. BiÃªn dá»‹ch Ä‘á»“ thá»‹
app = workflow.compile()

try:
    app.get_graph().draw_mermaid_png(output_file_path="D:\Project\-n-T-t-Nghi-p-\img\workflow_graph.png")
    print("ÄÃ£ váº½ sÆ¡ Ä‘á»“ workflow ra file: workflow_graph.png")
except Exception as e:
    print(f"KhÃ´ng thá»ƒ váº½ Ä‘á»“ thá»‹ (cáº§n cÃ i Ä‘áº·t pygraphviz): {e}")
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\graph\__init__.py`:

```````py
from .state import AgentState
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\services\amadeus_client.py`:

```````py
# src/flight_booking_agent/services/amadeus_client.py
import os
from amadeus import Client, ResponseError
from dotenv import load_dotenv

load_dotenv()

class AmadeusClient:
    def __init__(self):
        try:
            self.client = Client(
                client_id=os.getenv("AMADEUS_CLIENT_ID"),
                client_secret=os.getenv("AMADEUS_CLIENT_SECRET"),
                hostname=os.getenv("AMADEUS_HOSTNAME", "test") # Máº·c Ä‘á»‹nh lÃ  mÃ´i trÆ°á»ng test
            )
        except Exception as e:
            print(f"Lá»—i: KhÃ´ng thá»ƒ khá»Ÿi táº¡o Amadeus Client. Vui lÃ²ng kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng.")
            print(f"Chi tiáº¿t lá»—i: {e}")
            self.client = None

    def search_flights(self, origin, destination, departure_date, adults, non_stop=False, max_results=5):
        if not self.client:
            return {"error": "Amadeus Client chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o."}

        params = {
            'originLocationCode': origin,
            'destinationLocationCode': destination,
            'departureDate': departure_date,
            'adults': adults,
            'nonStop': 'true' if non_stop else 'false',
            'max': max_results,
            'currencyCode': 'VND'
        }
        
        print(f"--- Äang tÃ¬m kiáº¿m chuyáº¿n bay vá»›i tham sá»‘: {params} ---")
        try:
            response = self.client.shopping.flight_offers_search.get(**params)
            return self.format_flight_results(response.data)
        except ResponseError as error:
            print(f"Lá»—i API Amadeus: {error.response.result}")
            return {"error": "KhÃ´ng tÃ¬m tháº¥y chuyáº¿n bay hoáº·c cÃ³ lá»—i xáº£y ra.", "details": error.response.result}

    def format_flight_results(self, flight_data):
        """Äá»‹nh dáº¡ng láº¡i káº¿t quáº£ cho dá»… Ä‘á»c vÃ  xá»­ lÃ½."""
        formatted = []
        for offer in flight_data:
            itinerary = offer['itineraries'][0]
            segment = itinerary['segments'][0]
            price = offer['price']['total']
            
            formatted.append({
                "airline": segment['carrierCode'],
                "flight_number": f"{segment['carrierCode']}{segment['number']}",
                "departure_airport": segment['departure']['iataCode'],
                "departure_time": segment['departure']['at'],
                "arrival_airport": itinerary['segments'][-1]['arrival']['iataCode'],
                "arrival_time": itinerary['segments'][-1]['arrival']['at'],
                "duration": itinerary['duration'],
                "stops": len(itinerary['segments']) - 1,
                "price": float(price),
                "currency": "VND"
            })
        return formatted

# Táº¡o má»™t instance duy nháº¥t Ä‘á»ƒ toÃ n bá»™ á»©ng dá»¥ng sá»­ dá»¥ng
amadeus_client = AmadeusClient()
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\tools\booking_tools.py`:

```````py
# src/flight_booking_agent/tools/flight_tools.py
import json
from langchain_core.tools import tool
from pydantic import BaseModel, Field
from typing import Optional

# Import a-ma-de-us client Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o sáºµn
from ..services.amadeus_client import amadeus_client

class FlightSearchInput(BaseModel):
    """Cáº¥u trÃºc dá»¯ liá»‡u Ä‘áº§u vÃ o cho cÃ´ng cá»¥ tÃ¬m kiáº¿m chuyáº¿n bay."""
    origin: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘i. VÃ­ dá»¥: 'SGN'")
    destination: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘áº¿n. VÃ­ dá»¥: 'HAN'")
    departure_date: str = Field(description="NgÃ y Ä‘i theo Ä‘á»‹nh dáº¡ng YYYY-MM-DD.")
    adults: Optional[int] = Field(description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n.")

@tool("flight-search-tool", args_schema=FlightSearchInput)
def search_flights_tool(origin: str, destination: str, departure_date: str, adults: int = 1) -> str:
    """
    Sá»­ dá»¥ng cÃ´ng cá»¥ nÃ y Ä‘á»ƒ tÃ¬m kiáº¿m cÃ¡c chuyáº¿n bay.
    CÃ´ng cá»¥ sáº½ gá»i Ä‘áº¿n Amadeus API vá»›i cÃ¡c tham sá»‘ Ä‘Æ°á»£c cung cáº¥p.
    """
    print(f"--- TOOL: Báº¯t Ä‘áº§u tÃ¬m kiáº¿m chuyáº¿n bay tá»« {origin} Ä‘áº¿n {destination} vÃ o ngÃ y {departure_date} cho {adults} ngÆ°á»i lá»›n ---")
    
    # Sá»­ dá»¥ng amadeus_client Ä‘Ã£ import
    search_results = amadeus_client.search_flights(
        origin=origin,
        destination=destination,
        departure_date=departure_date,
        adults=adults,
        max_results=5 # Giá»›i háº¡n 5 káº¿t quáº£ cho ngáº¯n gá»n
    )
    
    # Tool cá»§a LangChain nÃªn tráº£ vá» má»™t chuá»—i (string), vÃ¬ váº­y ta chuyá»ƒn káº¿t quáº£ thÃ nh chuá»—i JSON
    if not search_results or "error" in search_results:
        return json.dumps({"error": "Xin lá»—i, tÃ´i khÃ´ng tÃ¬m tháº¥y chuyáº¿n bay nÃ o phÃ¹ há»£p hoáº·c Ä‘Ã£ cÃ³ lá»—i xáº£y ra."})
        
    return json.dumps(search_results, ensure_ascii=False, indent=2)
```````
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\services\amadeus_client.py`:

```````py
# src/flight_booking_agent/services/amadeus_client.py
import os
from amadeus import Client, ResponseError
from dotenv import load_dotenv

load_dotenv()

class AmadeusClient:
    def __init__(self):
        try:
            self.client = Client(
                client_id=os.getenv("AMADEUS_CLIENT_ID"),
                client_secret=os.getenv("AMADEUS_CLIENT_SECRET"),
                hostname=os.getenv("AMADEUS_HOSTNAME", "test") # Máº·c Ä‘á»‹nh lÃ  mÃ´i trÆ°á»ng test
            )
        except Exception as e:
            print(f"Lá»—i: KhÃ´ng thá»ƒ khá»Ÿi táº¡o Amadeus Client. Vui lÃ²ng kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng.")
            print(f"Chi tiáº¿t lá»—i: {e}")
            self.client = None

    def search_flights(self, origin, destination, departure_date, adults, non_stop=False, max_results=5):
        if not self.client:
            return {"error": "Amadeus Client chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o."}

        params = {
            'originLocationCode': origin,
            'destinationLocationCode': destination,
            'departureDate': departure_date,
            'adults': adults,
            'nonStop': 'true' if non_stop else 'false',
            'max': max_results,
            'currencyCode': 'VND'
        }
        
        print(f"--- Äang tÃ¬m kiáº¿m chuyáº¿n bay vá»›i tham sá»‘: {params} ---")
        try:
            response = self.client.shopping.flight_offers_search.get(**params)
            return self.format_flight_results(response.data)
        except ResponseError as error:
            print(f"Lá»—i API Amadeus: {error.response.result}")
            return {"error": "KhÃ´ng tÃ¬m tháº¥y chuyáº¿n bay hoáº·c cÃ³ lá»—i xáº£y ra.", "details": error.response.result}

    def format_flight_results(self, flight_data):
        """Äá»‹nh dáº¡ng láº¡i káº¿t quáº£ cho dá»… Ä‘á»c vÃ  xá»­ lÃ½."""
        formatted = []
        for offer in flight_data:
            itinerary = offer['itineraries'][0]
            segment = itinerary['segments'][0]
            price = offer['price']['total']
            
            formatted.append({
                "airline": segment['carrierCode'],
                "flight_number": f"{segment['carrierCode']}{segment['number']}",
                "departure_airport": segment['departure']['iataCode'],
                "departure_time": segment['departure']['at'],
                "arrival_airport": itinerary['segments'][-1]['arrival']['iataCode'],
                "arrival_time": itinerary['segments'][-1]['arrival']['at'],
                "duration": itinerary['duration'],
                "stops": len(itinerary['segments']) - 1,
                "price": float(price),
                "currency": "VND"
            })
        return formatted

# Táº¡o má»™t instance duy nháº¥t Ä‘á»ƒ toÃ n bá»™ á»©ng dá»¥ng sá»­ dá»¥ng
amadeus_client = AmadeusClient()
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\tools\booking_tools.py`:

```````py
# src/flight_booking_agent/tools/flight_tools.py
import json
from langchain_core.tools import tool
from pydantic import BaseModel, Field
from typing import Optional

# Import a-ma-de-us client Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o sáºµn
from ..services.amadeus_client import amadeus_client

class FlightSearchInput(BaseModel):
    """Cáº¥u trÃºc dá»¯ liá»‡u Ä‘áº§u vÃ o cho cÃ´ng cá»¥ tÃ¬m kiáº¿m chuyáº¿n bay."""
    origin: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘i. VÃ­ dá»¥: 'SGN'")
    destination: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘áº¿n. VÃ­ dá»¥: 'HAN'")
    departure_date: str = Field(description="NgÃ y Ä‘i theo Ä‘á»‹nh dáº¡ng YYYY-MM-DD.")
    adults: Optional[int] = Field(description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n.")

@tool("flight-search-tool", args_schema=FlightSearchInput)
def search_flights_tool(origin: str, destination: str, departure_date: str, adults: int = 1) -> str:
    """
    Sá»­ dá»¥ng cÃ´ng cá»¥ nÃ y Ä‘á»ƒ tÃ¬m kiáº¿m cÃ¡c chuyáº¿n bay.
    CÃ´ng cá»¥ sáº½ gá»i Ä‘áº¿n Amadeus API vá»›i cÃ¡c tham sá»‘ Ä‘Æ°á»£c cung cáº¥p.
    """
    print(f"--- TOOL: Báº¯t Ä‘áº§u tÃ¬m kiáº¿m chuyáº¿n bay tá»« {origin} Ä‘áº¿n {destination} vÃ o ngÃ y {departure_date} cho {adults} ngÆ°á»i lá»›n ---")
    
    # Sá»­ dá»¥ng amadeus_client Ä‘Ã£ import
    search_results = amadeus_client.search_flights(
        origin=origin,
        destination=destination,
        departure_date=departure_date,
        adults=adults,
        max_results=5 # Giá»›i háº¡n 5 káº¿t quáº£ cho ngáº¯n gá»n
    )
    
    # Tool cá»§a LangChain nÃªn tráº£ vá» má»™t chuá»—i (string), vÃ¬ váº­y ta chuyá»ƒn káº¿t quáº£ thÃ nh chuá»—i JSON
    if not search_results or "error" in search_results:
        return json.dumps({"error": "Xin lá»—i, tÃ´i khÃ´ng tÃ¬m tháº¥y chuyáº¿n bay nÃ o phÃ¹ há»£p hoáº·c Ä‘Ã£ cÃ³ lá»—i xáº£y ra."})
        
    return json.dumps(search_results, ensure_ascii=False, indent=2)
```````
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\services\amadeus_client.py`:

```````py
# src/flight_booking_agent/services/amadeus_client.py
import os
from amadeus import Client, ResponseError
from dotenv import load_dotenv

load_dotenv()

class AmadeusClient:
    def __init__(self):
        try:
            self.client = Client(
                client_id=os.getenv("AMADEUS_CLIENT_ID"),
                client_secret=os.getenv("AMADEUS_CLIENT_SECRET"),
                hostname=os.getenv("AMADEUS_HOSTNAME", "test") # Máº·c Ä‘á»‹nh lÃ  mÃ´i trÆ°á»ng test
            )
        except Exception as e:
            print(f"Lá»—i: KhÃ´ng thá»ƒ khá»Ÿi táº¡o Amadeus Client. Vui lÃ²ng kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng.")
            print(f"Chi tiáº¿t lá»—i: {e}")
            self.client = None

    def search_flights(self, origin, destination, departure_date, adults, non_stop=False, max_results=5):
        if not self.client:
            return {"error": "Amadeus Client chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o."}

        params = {
            'originLocationCode': origin,
            'destinationLocationCode': destination,
            'departureDate': departure_date,
            'adults': adults,
            'nonStop': 'true' if non_stop else 'false',
            'max': max_results,
            'currencyCode': 'VND'
        }
        
        print(f"--- Äang tÃ¬m kiáº¿m chuyáº¿n bay vá»›i tham sá»‘: {params} ---")
        try:
            response = self.client.shopping.flight_offers_search.get(**params)
            return self.format_flight_results(response.data)
        except ResponseError as error:
            print(f"Lá»—i API Amadeus: {error.response.result}")
            return {"error": "KhÃ´ng tÃ¬m tháº¥y chuyáº¿n bay hoáº·c cÃ³ lá»—i xáº£y ra.", "details": error.response.result}

    def format_flight_results(self, flight_data):
        """Äá»‹nh dáº¡ng láº¡i káº¿t quáº£ cho dá»… Ä‘á»c vÃ  xá»­ lÃ½."""
        formatted = []
        for offer in flight_data:
            itinerary = offer['itineraries'][0]
            segment = itinerary['segments'][0]
            price = offer['price']['total']
            
            formatted.append({
                "airline": segment['carrierCode'],
                "flight_number": f"{segment['carrierCode']}{segment['number']}",
                "departure_airport": segment['departure']['iataCode'],
                "departure_time": segment['departure']['at'],
                "arrival_airport": itinerary['segments'][-1]['arrival']['iataCode'],
                "arrival_time": itinerary['segments'][-1]['arrival']['at'],
                "duration": itinerary['duration'],
                "stops": len(itinerary['segments']) - 1,
                "price": float(price),
                "currency": "VND"
            })
        return formatted

# Táº¡o má»™t instance duy nháº¥t Ä‘á»ƒ toÃ n bá»™ á»©ng dá»¥ng sá»­ dá»¥ng
amadeus_client = AmadeusClient()
```````

`\\?\D:\Project\-n-T-t-Nghi-p-\src\flight_booking_agent\tools\booking_tools.py`:

```````py
# src/flight_booking_agent/tools/flight_tools.py
import json
from langchain_core.tools import tool
from pydantic import BaseModel, Field
from typing import Optional

# Import a-ma-de-us client Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o sáºµn
from ..services.amadeus_client import amadeus_client

class FlightSearchInput(BaseModel):
    """Cáº¥u trÃºc dá»¯ liá»‡u Ä‘áº§u vÃ o cho cÃ´ng cá»¥ tÃ¬m kiáº¿m chuyáº¿n bay."""
    origin: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘i. VÃ­ dá»¥: 'SGN'")
    destination: str = Field(description="MÃ£ IATA cá»§a thÃ nh phá»‘ Ä‘áº¿n. VÃ­ dá»¥: 'HAN'")
    departure_date: str = Field(description="NgÃ y Ä‘i theo Ä‘á»‹nh dáº¡ng YYYY-MM-DD.")
    adults: Optional[int] = Field(description="Sá»‘ lÆ°á»£ng hÃ nh khÃ¡ch ngÆ°á»i lá»›n.")

@tool("flight-search-tool", args_schema=FlightSearchInput)
def search_flights_tool(origin: str, destination: str, departure_date: str, adults: int) -> str:
    """
    Sá»­ dá»¥ng cÃ´ng cá»¥ nÃ y Ä‘á»ƒ tÃ¬m kiáº¿m cÃ¡c chuyáº¿n bay.
    CÃ´ng cá»¥ sáº½ gá»i Ä‘áº¿n Amadeus API vá»›i cÃ¡c tham sá»‘ Ä‘Æ°á»£c cung cáº¥p.
    """
    print(f"--- TOOL: Báº¯t Ä‘áº§u tÃ¬m kiáº¿m chuyáº¿n bay tá»« {origin} Ä‘áº¿n {destination} vÃ o ngÃ y {departure_date} cho {adults} ngÆ°á»i lá»›n ---")
    
    # Sá»­ dá»¥ng amadeus_client Ä‘Ã£ import
    search_results = amadeus_client.search_flights(
        origin=origin,
        destination=destination,
        departure_date=departure_date,
        adults=adults,
        max_results=10 # Giá»›i háº¡n 5 káº¿t quáº£ cho ngáº¯n gá»n
    )
    
    # Tool cá»§a LangChain nÃªn tráº£ vá» má»™t chuá»—i (string), vÃ¬ váº­y ta chuyá»ƒn káº¿t quáº£ thÃ nh chuá»—i JSON
    if not search_results or "error" in search_results:
        return json.dumps({"error": "Xin lá»—i, tÃ´i khÃ´ng tÃ¬m tháº¥y chuyáº¿n bay nÃ o phÃ¹ há»£p hoáº·c Ä‘Ã£ cÃ³ lá»—i xáº£y ra."})
        
    return json.dumps(search_results, ensure_ascii=False, indent=2)



```````